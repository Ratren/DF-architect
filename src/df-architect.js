/*! For license information please see df-architect.js.LICENSE.txt */
(()=>{"use strict";var e=[,(e,t,a)=>{function __WEBPACK_DEFAULT_EXPORT__(){Map.prototype.getOrDefault||(Map.prototype.getOrDefault=function(e,t){var a=this.get(e);return void 0===a&&(a=t instanceof Function?t():t,this.set(e,a)),a}),String.prototype.localize||(String.prototype.localize=function(){return game.i18n.localize(this.valueOf())})}a.r(t),a.d(t,{default:()=>__WEBPACK_DEFAULT_EXPORT__})},(e,t,a)=>{a.r(t),a.d(t,{default:()=>SETTINGS});class SETTINGS{static _MOD_NAME;static init(e){this._MOD_NAME=e}static register(e,t){game.settings.register(SETTINGS._MOD_NAME,e,t)}static registerMenu(e,t){game.settings.registerMenu(SETTINGS._MOD_NAME,e,t)}static get(e){return game.settings.get(SETTINGS._MOD_NAME,e)}static async set(e,t){return await game.settings.set(SETTINGS._MOD_NAME,e,t)}static default(e){return game.settings.settings.get(SETTINGS._MOD_NAME+"."+e).default}static typeOf(){return Object}}},(e,t,a)=>{a.r(t),a.d(t,{default:()=>ARCHITECT});class ARCHITECT{static MOD_NAME="df-architect";static reportProgress(e,t,a,i=!1){const r=document.getElementById("loading"),n=Math.round(t/a*100);r.querySelector("#context").textContent=e+` (${t}/${a})`,r.querySelector("#loading-bar").style.width=`${n}%`,r.querySelector("#progress").textContent=`${n}%`,r.style.display="block",100!==n||r.hidden||i||$(r).fadeOut(2e3)}static hideProgress(e=!1){e?$("#loading").hide():$("#loading").fadeOut(2e3)}static requestReload(){const e=new Dialog({title:"DF_ARCHITECT.ReloadRequired.Title".localize(),content:"DF_ARCHITECT.ReloadRequired.Content".localize(),default:"yes",buttons:{no:{icon:'<i class="fas fa-times"><╱i>',label:"DF_ARCHITECT.ReloadRequired.Negative".localize(),callback:async()=>await e.close()},yes:{icon:'<i class="fas fa-check"><╱i>',label:"DF_ARCHITECT.ReloadRequired.Positive".localize(),callback:()=>window.location.reload()}}});e.render(!0)}static Base64ToBlob(e,t,a=512){const i=atob(e),r=[];for(let e=0;e<i.length;e+=a){const t=i.slice(e,e+a),n=new Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);const l=new Uint8Array(n);r.push(l)}return new Blob(r,{type:t})}static getLayer(e){const t=canvas[e];return t||CONFIG.Canvas.layers[e].layerClass.instance}static GR_BG_HI="44";static GR_BG_LO="08";static GR_BG_BDR="36a";static GR_BG_TCT="4d4";static GRAPHIC=["%c                                                                      %c%c","%c  ╭────────────────────────────────────────────────────────────────╮  %c%c","%c  │ %c ______  ╭╮  ○    ◌   __  ○     ◌ __        ╭╮    ○   __       %c│  ","%c  │ %c╱╲  _  ╲ ╰╯     ╭╮   ╱╲ ╲    ◌ __╱╲ ╲__  ○  ╰╯  ╭╮   ╱╲ ╲__  ◌ %c│  ","%c  │ %c╲ ╲ ╲L╲ ╲  _ __ ╰╯___╲ ╲ ╲____╱╲_╲ ╲  _╲   ____ ╰╯___╲ ╲  _╲   %c│  ","%c  │ %c ╲ ╲  __ ╲╱╲╵ __╲╱ ___╲ ╲  __ ╲╱╲ ╲ ╲ ╲╱  ╱ __ ╲ ╱ ___╲ ╲ ╲╱○  %c│  ","%c  │ %c  ╲ ╲ ╲╱╲ ╲ ╲ ╲╱╱╲ ╲__╱╲ ╲ ╲ ╲ ╲ ╲ ╲ ╲ ╲_╱╲  __╱╱╲ ╲__╱╲ ╲ ╲_  %c│  ","%c  │ %c ◌ ╲ ╲_╲ ╲_╲ ╲_╲╲ ╲____╲╲ ╲_╲ ╲_╲ ╲_╲ ╲__╲ ╲____╲ ╲____╲╲ ╲__╲ %c│  ","%c  │ %c    ╲╱_╱╲╱_╱╲╱_╱ ╲╱____╱ ╲╱_╱╲╱_╱╲╱_╱╲╱__╱╲╱____╱╲╱____╱ ╲╱__╱ %c│  ","%c  ╰────────────────────────────────────────────────────────────────╯  %c%c","%c                                                                      %c%c"];static DrawArchitectGraphicToConsole(){const e=[],t=parseInt(this.GR_BG_LO,16),a=parseInt(this.GR_BG_HI,16),i=`;color:#${this.GR_BG_BDR}`,r=`;color:#${this.GR_BG_TCT}`;for(let l=0;l<this.GRAPHIC.length;l++){var n=Math.trunc((this.GRAPHIC.length-1-l)/(this.GRAPHIC.length-1)*(a-t))+t;n="background:#"+(n<16?"0"+n.toString(16):n.toString(16)).repeat(3),e.push(n+i),e.push(n+r),e.push(n+i)}console.log(ARCHITECT.GRAPHIC.join("\n"),...e)}}},(e,t,a)=>{a.r(t),a.d(t,{default:()=>PIXIAppOverride});class PIXIAppOverride{static setup(){Hooks.once("canvasConfig",(e=>{e.preserveDrawingBuffer=!0,e.transparent=!0}))}static ready(){canvas.app&&(canvas.app.renderer.backgroundAlpha=1)}}},(e,t,a)=>{a.r(t),a.d(t,{default:()=>LayerShortcuts});var i=a(3),r=a(2);class LayerShortcuts{static PREF_LAYER_SWAP_LAYER1="LayerShortcutsSettingsLayer-SwapLayer1";static PREF_LAYER_SWAP_LAYER2="LayerShortcutsSettingsLayer-SwapLayer2";static init(){game.keybindings.register(i.default.MOD_NAME,"LayerShortcuts.QuickSwap",{restricted:!0,name:"DF_ARCHITECT.LayerShortcuts.Settings.QuickSwap.Title".localize(),hint:"DF_ARCHITECT.LayerShortcuts.Settings.QuickSwap.Info".localize(),editable:[{key:"KeyQ",modifiers:[KeyboardManager.MODIFIER_KEYS.ALT]}],onDown:()=>{const e=r.default.get(LayerShortcuts.PREF_LAYER_SWAP_LAYER1),t=r.default.get(LayerShortcuts.PREF_LAYER_SWAP_LAYER2),a=ui.controls.activeControl===e?t:e;return ui.controls._onClickLayer({preventDefault:()=>{},currentTarget:{dataset:{control:a}}}),!0}});const e=[["tokens",CONFIG.Canvas.layers.tokens.layerClass.name],["templates",CONFIG.Canvas.layers.templates.layerClass.name],["tiles",CONFIG.Canvas.layers.tiles.layerClass.name],["drawings",CONFIG.Canvas.layers.drawings.layerClass.name],["walls",CONFIG.Canvas.layers.walls.layerClass.name],["lighting",CONFIG.Canvas.layers.lighting.layerClass.name],["sounds",CONFIG.Canvas.layers.sounds.layerClass.name],["notes",CONFIG.Canvas.layers.notes.layerClass.name]];var t=0;for(let a of e)game.keybindings.register(i.default.MOD_NAME,a[0],{restricted:!0,name:a[1].replace("Layer"," Layer"),hint:"DF_ARCHITECT.LayerShortcuts.Settings.Description",editable:[{key:"Digit"+ ++t,modifiers:[KeyboardManager.MODIFIER_KEYS.CONTROL]}],onDown:()=>(i.default.getLayer(a[0])?.activate(),!0)})}static ready(){const getLayers=()=>{const e={};return ui.controls.controls.map((e=>[e.name,e.title])).forEach((t=>{e[t[0]]=t[1]})),e};r.default.register(LayerShortcuts.PREF_LAYER_SWAP_LAYER1,{name:"DF_ARCHITECT.LayerShortcuts.Settings.QuickSwap.Layer1_Name",hint:"DF_ARCHITECT.LayerShortcuts.Settings.QuickSwap.Layer1_Hint",choices:getLayers(),scope:"world",type:String,config:!0,default:"walls"}),r.default.register(LayerShortcuts.PREF_LAYER_SWAP_LAYER2,{name:"DF_ARCHITECT.LayerShortcuts.Settings.QuickSwap.Layer2_Name",hint:"DF_ARCHITECT.LayerShortcuts.Settings.QuickSwap.Layer2_Hint",choices:getLayers(),scope:"world",type:String,config:!0,default:"lighting"})}}},(e,t,a)=>{a.r(t),a.d(t,{default:()=>AltGridSnap});var i=a(3),r=a(2);class AltGridSnap{static PREF_ENABLED="AltGridSnap.Enabled";static PREF_TOGGLED="AltGridSnap.Toggled";static PREF_PLACE_ON_CONTROL_BAR="AltGridSnap.PlaceOnControlBar";static init(){r.default.register(AltGridSnap.PREF_TOGGLED,{scope:"client",config:!1,type:Boolean,default:!1,onChange:e=>{if(r.default.get(AltGridSnap.PREF_PLACE_ON_CONTROL_BAR)){const t=$("ol#controls>li#df-arch-altSnap");e?t.addClass("active"):t.removeClass("active")}else ui.controls.control.tools.find((e=>"altSnap"===e.name)).active=e,ui.controls.render()}}),r.default.register(AltGridSnap.PREF_ENABLED,{scope:"world",config:!0,name:"DF_ARCHITECT.AltGridSnap.Setting.EnabledName",hint:"DF_ARCHITECT.AltGridSnap.Setting.EnabledHint",type:Boolean,default:!1,onChange:()=>{this._patchSquareGrid(),ui.controls.initialize()}}),r.default.register(AltGridSnap.PREF_PLACE_ON_CONTROL_BAR,{scope:"world",config:!0,name:"DF_ARCHITECT.AltGridSnap.Setting.PlaceOnControlBarName",hint:"DF_ARCHITECT.AltGridSnap.Setting.PlaceOnControlBarHint",type:Boolean,default:!1,onChange:()=>{ui.controls.initialize(),ui.controls.render(!0)}}),game.keybindings.register(i.default.MOD_NAME,"AltSnapGrid.Toggle",{restricted:!0,name:"DF_ARCHITECT.AltGridSnap.Hotkey_Toggle",editable:[{key:"KeyS",modifiers:[KeyboardManager.MODIFIER_KEYS.ALT]}],onDown:()=>(this.enabled&&(this.toggled=!this.toggled),this.enabled)}),this.enabled&&this._patchSquareGrid(),Hooks.on("getSceneControlButtons",(e=>{if(!this.enabled)return;if(r.default.get(AltGridSnap.PREF_PLACE_ON_CONTROL_BAR))return;const t=game.user.isGM,a=this.toggled;for(let i of e)i.tools.splice(0,0,{icon:"df df-alt-snap",name:"altSnap",title:"DF_ARCHITECT.AltGridSnap.Label",visible:t,toggle:!0,active:a,onClick:e=>this.toggled=e})})),Hooks.on("renderSceneControls",((e,t,a)=>{if(!r.default.get(AltGridSnap.PREF_PLACE_ON_CONTROL_BAR))return;const i=$(`\n<li class="scene-control toggle" id="df-arch-altSnap" style="line-height:0" title="${"DF_ARCHITECT.AltGridSnap.Label".localize()}">\n\t<i class="df df-alt-snap"></i>\n</li>`);i.on("click",(()=>{i.hasClass("active")?(this.toggled=!1,i.removeClass("active")):(this.toggled=!0,i.addClass("active"))})),this.toggled&&i.addClass("active"),t.find(".main-controls").append(i)}))}static get enabled(){return r.default.get(AltGridSnap.PREF_ENABLED)}static get toggled(){return r.default.get(AltGridSnap.PREF_TOGGLED)}static set toggled(e){r.default.set(AltGridSnap.PREF_TOGGLED,e)}static _patchSquareGrid(){this.enabled?libWrapper.register(i.default.MOD_NAME,"SquareGrid.prototype.getSnappedPosition",this._SquareGrid_getSnappedPosition,"WRAPPER"):libWrapper.unregister(i.default.MOD_NAME,"SquareGrid.prototype.getSnappedPosition")}static _SquareGrid_getSnappedPosition(e,t,a,i){if(AltGridSnap.enabled&&AltGridSnap.toggled){i||(i=1);const r=canvas.dimensions.size/(2*i),n=e(t-r,a-r,i);return{x:n.x+r,y:n.y+r}}return e(t,a,i)}}},(e,t,a)=>{a.r(t),a.d(t,{default:()=>WallCtrlInvert});var i=a(3),r=a(2),n=a(8);class WallCtrlInvert{static PREF_ENABLED="WallCtrlInvert-Enabled";static _invertKeyboardMap=!1;static _onDragLeftDropRegistrationId=-1;static get enabled(){return r.default.get(WallCtrlInvert.PREF_ENABLED)}static set enabled(e){r.default.set(WallCtrlInvert.PREF_ENABLED,e)}static init(){r.default.register(WallCtrlInvert.PREF_ENABLED,{scope:"world",config:!1,type:Boolean,default:!1,onChange:e=>{e?(libWrapper.register(i.default.MOD_NAME,"KeyboardManager.prototype.isModifierActive",this._isModifierActive,"WRAPPER"),this._onDragLeftDropRegistrationId=n.default.register("WallsLayer.prototype._onDragLeftDrop",this._onDragLeftDrop)):(libWrapper.unregister(i.default.MOD_NAME,"KeyboardManager.prototype.isModifierActive",!1),n.default.unregister("WallsLayer.prototype._onDragLeftDrop",this._onDragLeftDropRegistrationId))}}),game.keybindings.register(i.default.MOD_NAME,"ctrlInvert",{restricted:!0,name:"DF_ARCHITECT.WallCtrlInvert.Name",editable:[{key:"KeyC",modifiers:[KeyboardManager.MODIFIER_KEYS.ALT]}],onDown:async()=>(await r.default.set(WallCtrlInvert.PREF_ENABLED,!this.enabled),ui.controls.initialize(),!0)}),Hooks.on("getSceneControlButtons",(e=>{const t=game.user.isGM,a=e.find((e=>"walls"===e.name));a.tools.splice(a.tools.findIndex((e=>"snap"===e.name)),0,{icon:"fas fa-link",name:"ctrlInvert",title:"DF_ARCHITECT.WallCtrlInvert.Title",visible:t,toggle:!0,active:this.enabled,onClick:e=>{this.enabled=e}})}))}static ready(){r.default.get(WallCtrlInvert.PREF_ENABLED)&&(libWrapper.register(i.default.MOD_NAME,"KeyboardManager.prototype.isModifierActive",this._isModifierActive,"WRAPPER"),this._onDragLeftDropRegistrationId=n.default.register("WallsLayer.prototype._onDragLeftDrop",this._onDragLeftDrop))}static _onDragLeftDrop(e,t){WallCtrlInvert._invertKeyboardMap=!0;const a=e(t);return WallCtrlInvert._invertKeyboardMap=!1,a}static _isModifierActive(e,...t){if(!WallCtrlInvert._invertKeyboardMap)return e(...t);const a=new Set(game.keyboard.downKeys);KeyboardManager.MODIFIER_CODES[KeyboardManager.MODIFIER_KEYS.CONTROL].some((e=>game.keyboard.downKeys.has(e)))?KeyboardManager.MODIFIER_CODES[KeyboardManager.MODIFIER_KEYS.CONTROL].forEach((e=>game.keyboard.downKeys.delete(e))):game.keyboard.downKeys.add(KeyboardManager.MODIFIER_CODES[KeyboardManager.MODIFIER_KEYS.CONTROL][0]);const i=e(...t);return game.keyboard.downKeys=a,i}}},(e,t,a)=>{a.r(t),a.d(t,{default:()=>libWrapperShared});var i=a(3);class Registration{nextId=0;wrappers=new Map;handler(e,t,...a){const i=[...this.wrappers.values()];let current=(...a)=>i[0].call(e,t,...a);for(let t=1;t<i.length;t++){const a=current;current=(...r)=>i[t].call(e,a,...r)}current.apply(e,a)}}class libWrapperShared{static registrations=new Map;static register(e,t){let a=this.registrations.get(e);a||(a=new Registration,libWrapper.register(i.default.MOD_NAME,e,(function(e,...t){a.handler(this,e,...t)}),"WRAPPER"),this.registrations.set(e,a));const r=a.nextId++;return a.wrappers.set(r,t),r}static unregister(e,t){const a=this.registrations.get(e);return!!a&&(a.wrappers.delete(t),0===a.wrappers.size&&(libWrapper.unregister(i.default.MOD_NAME,e,!1),this.registrations.delete(e)),!0)}}},(e,t,a)=>{a.r(t),a.d(t,{default:()=>WallShortcuts});var i=a(3),r=a(8);class WallShortcuts{static WALL_TYPES=new Set(["walls","terrain","invisible","ethereal","doors","secret"]);static init(){const e=[{name:"walls",title:"Normal Walls"},{name:"terrain",title:"Terrain Walls"},{name:"invisible",title:"Invisible Walls"},{name:"ethereal",title:"Ethereal Walls"},{name:"doors",title:"Normal Doors"},{name:"secret",title:"Secret Doors"}];var t=0;for(let a of e){const e=a;game.keybindings.register(i.default.MOD_NAME,`WallShortcuts-${a.name}`,{restricted:!0,name:a.title,hint:"DF_ARCHITECT.WallShortcuts.Settings.Description",editable:[{key:"Digit"+ ++t,modifiers:[KeyboardManager.MODIFIER_KEYS.SHIFT]}],onDown:()=>{if("walls"!==ui.controls.activeControl)return!1;if(ui.controls._onClickTool({preventDefault:function(){},currentTarget:{dataset:{tool:e.name}}}),canvas.walls.preview.children.length>0&&canvas.walls.preview.children[0]instanceof Wall){const e=canvas.walls._getWallDataFromActiveTool(game.activeTool);for(const t of Object.keys(e))canvas.walls.preview.children[0].document.data[t]=e[t]}return!0}})}game.keybindings.register(i.default.MOD_NAME,"WallShortcuts-ForceGridSnap",{restricted:!0,name:"DF_ARCHITECT.WallShortcuts.Settings.ToggleForceSnapName",hint:"DF_ARCHITECT.WallShortcuts.Settings.ToggleForceSnapHint",editable:[{key:"F",modifiers:[]}],onDown:()=>{canvas.activeLayer instanceof WallsLayer&&$('#controls li[data-tool="snap"]').trigger("click")}}),libWrapper.register(i.default.MOD_NAME,"WallsLayer.prototype._onDragLeftStart",this._patchForceSnap,"WRAPPER"),r.default.register("WallsLayer.prototype._onDragLeftDrop",this._patchForceSnap)}static _patchForceSnap(e,t){let a=canvas.walls._forceSnap;if(!a)return e(t);t.data.originalEvent.shiftKey&&(canvas.walls._forceSnap=!1);const i=e(t);return canvas.walls._forceSnap=a,i}}},(e,t,a)=>{a.r(t),a.d(t,{default:()=>WallJoinSplit});var i=a(2);class WallJoinSplit{static PREF_ENABLED="WallJoinSplit-Enabled";static get enabled(){return i.default.get(WallJoinSplit.PREF_ENABLED)}static set enabled(e){i.default.set(WallJoinSplit.PREF_ENABLED,e)}static init(){Hooks.on("getSceneControlButtons",(e=>{const t=game.user.isGM,a=e.find((e=>"walls"===e.name));a.tools.splice(a.tools.findIndex((e=>"clone"===e.name))+1,0,{icon:"df df-alt-split",name:"split",title:"DF_ARCHITECT.WallJoinSplit.Split_Label",button:!0,visible:t,onClick:this._splitWalls.bind(this)},{icon:"df df-alt-join",name:"join",title:"DF_ARCHITECT.WallJoinSplit.Join_Label",button:!0,visible:t,onClick:this._joinWalls.bind(this)})}))}static async _splitWalls(){const e=canvas.walls,t=e.controlled,a=[];for(let n of t){const[t,l,s,o]=n.document.c;var i=(t+s)/2,r=(l+o)/2;[i,r]=e._getWallEndpointCoordinates(new PIXI.Point(i,r),{snap:!1});const c=duplicate(n.document._source);c.c=[t,l,i,r],delete c._id;const d=duplicate(n.document._source);d.c=[i,r,s,o],delete d._id,a.push(c,d)}await game.scenes.viewed.deleteEmbeddedDocuments("Wall",t.map((e=>e.id)));const n=await game.scenes.viewed.createEmbeddedDocuments("Wall",a);for(let t of n){const a=e.get(t.id);a.visible&&a.can(game.user,"control")&&a.control({releaseOthers:!1})}}static async _joinWalls(){const e=new Map,t=canvas.walls,a=t.controlled;for(let i of a){const[a,r,n,l]=i.document.c;e.getOrDefault(JSON.stringify(t._getWallEndpointCoordinates(new PIXI.Point(a,r),{snap:!1})),[]).push(i),e.getOrDefault(JSON.stringify(t._getWallEndpointCoordinates(new PIXI.Point(n,l),{snap:!1})),[]).push(i)}if([...e.values()].reduce(((e,t)=>2!=t.length?e+1:e),0)>2)return void ui.notifications.error("Selected walls are disjointed. Make sure they are a single line of connected walls.");const i=[...e.entries()].filter((e=>1==e[1].length)),r=duplicate(i[0][1][0].document._source);delete r._id,r.c=i.reduce(((e,t)=>e.concat(JSON.parse(t[0]))),[]),await game.scenes.viewed.deleteEmbeddedDocuments("Wall",a.map((e=>e.id)));const n=await game.scenes.viewed.createEmbeddedDocuments("Wall",[r]);for(let e of n)e.object.control()}}},(e,t,a)=>{a.r(t),a.d(t,{default:()=>AltLightOrigin});var i=a(3),r=a(2);class AltLightOrigin{static LIGHTING_LAYER="lighting";static KEYEVENT_UP="keyup";static KEYEVENT_DOWN="keydown";static PREF_COLOUR1="AltLightOrigin.Colour1";static PREF_COLOUR2="AltLightOrigin.Colour2";static _showCrosshairs=!1;static get showCrosshairs(){return this._showCrosshairs}static _alternateColour=!1;static get alternateColour(){return this._alternateColour}static _controls=new Set;static register(e){this._controls.add(e)}static deregister(e){this._controls.delete(e)}static init(){libWrapper.register(i.default.MOD_NAME,"AmbientLight.prototype._drawControlIcon",(()=>{const e=Math.max(20*Math.round(.5*canvas.dimensions.size/20),40);let t=new AltLightControlIcon({texture:CONFIG.controlIcons.light,size:e});return t.x-=.5*e,t.y-=.5*e,t}),"OVERRIDE")}static ready(){new window.Ardittristan.ColorSetting(i.default.MOD_NAME,AltLightOrigin.PREF_COLOUR1,{name:"DF_ARCHITECT.AltLightOrigin.Settings.Colour1_Name",hint:"DF_ARCHITECT.AltLightOrigin.Settings.Colour1_Hint",label:"DF_ARCHITECT.AltLightOrigin.Settings.Colour1_Name",restricted:!0,defaultColor:"#ffffffff",scope:"world"}),new window.Ardittristan.ColorSetting(i.default.MOD_NAME,AltLightOrigin.PREF_COLOUR2,{name:"DF_ARCHITECT.AltLightOrigin.Settings.Colour2_Name",hint:"DF_ARCHITECT.AltLightOrigin.Settings.Colour2_Hint",label:"DF_ARCHITECT.AltLightOrigin.Settings.Colour2_Name",restricted:!0,defaultColor:"#ff5500ff",scope:"world"}),Hooks.on("renderSceneControls",(e=>{e.activeControl===AltLightOrigin.LIGHTING_LAYER?(window.addEventListener(AltLightOrigin.KEYEVENT_DOWN,this._keyEventHandler.bind(this)),window.addEventListener(AltLightOrigin.KEYEVENT_UP,this._keyEventHandler.bind(this))):(window.removeEventListener(AltLightOrigin.KEYEVENT_DOWN,this._keyEventHandler.bind(this)),window.removeEventListener(AltLightOrigin.KEYEVENT_UP,this._keyEventHandler.bind(this)))}))}static _keyEventHandler(e){e.repeat||"ShiftLeft"!==e.code&&"ShiftRight"!==e.code&&"AltLeft"!==e.code&&"AltRight"!==e.code||(this._showCrosshairs=e.shiftKey,this._alternateColour=e.altKey,this._controls.forEach((e=>e.draw())))}}class AltLightControlIcon extends ControlIcon{constructor({texture:e,size:t=40,borderColor:a=16733440,tint:i=null}){super({texture:e,size:t,borderColor:a,tint:i}),AltLightOrigin.register(this)}async draw(){if(!AltLightOrigin.showCrosshairs)return this.icon.alpha=1,this.icon.texture?super.draw():this;this.icon.alpha=0,this.border.clear().lineStyle(2,this.borderColor,1).drawRoundedRect(...this.rect,5).endFill(),this.border.visible=!1;const parseColour=e=>(e.startsWith("#")&&(e=e.substr(1)),8===e.length&&(e=e.substr(0,6)),parseInt("0x"+e));var e=parseColour(r.default.get(AltLightOrigin.alternateColour?AltLightOrigin.PREF_COLOUR2:AltLightOrigin.PREF_COLOUR1));return isNaN(e)&&(e=parseColour(r.default.default(AltLightOrigin.alternateColour?AltLightOrigin.PREF_COLOUR2:AltLightOrigin.PREF_COLOUR1))),this.bg.clear().lineStyle(1,e,1).moveTo(this.rect[0]-1,this.rect[1]-1).lineTo(this.rect[2]-1,this.rect[3]-1).moveTo(this.rect[2]-1,this.rect[1]-1).lineTo(this.rect[0]-1,this.rect[3]-1).lineStyle(2,e,1).drawEllipse(this.rect[0]+this.rect[2]/2,this.rect[1]+this.rect[3]/2,this.rect[2]/2,this.rect[3]/2).endFill(),this}destroy(e){super.destroy(e),AltLightOrigin.deregister(this)}}},(e,t,a)=>{a.r(t),a.d(t,{QuickColourPicker:()=>i});class _QuickColourPicker{SIZE=5;HALF_SIZE=Math.trunc(this.SIZE/2);_BUTTON_HTML="";_rows;_pixels=null;_colour;_currentApp;_enabled=!1;_promise=null;_states=null;_html=$(`<div id="swatch">\n\t<table>\n\t\t${("<tr>"+"<td></td>".repeat(this.SIZE)+"</tr>").repeat(this.SIZE)}\n\t</table>\n</div>`)[0];_docObserver=new MutationObserver(this._handleMutation);constructor(){this._rows=this._html.querySelectorAll("tr")}ready(){this._BUTTON_HTML=`<button type="button" tabindex="-1" style="flex:0 0" class="df-arch-colourpicker" title="${"DF_ARCHITECT.QuickColourPicker.EyeDrop_Title".localize()}"><i class="fas fa-eye-dropper"></i></button>`,document.addEventListener("mousemove",this._handleMouseMove.bind(this)),document.addEventListener("mousedown",this._handleMouseDownUp.bind(this)),document.addEventListener("mouseup",this._handleMouseDownUp.bind(this)),this._docObserver.observe(document.body,{childList:!0})}_handleMutation(e,t){for(let t of e)t.addedNodes.forEach((e=>{if(!(e instanceof HTMLElement))return;if(!e.classList.contains("window-app"))return;const t=$(e),a=parseInt(t.data("appid"));if(isNaN(a))return;const r=ui.windows[a];t.find('input[type="color"]').each(((e,t)=>{const a=$(i._BUTTON_HTML);a.on("click",(async e=>{e.preventDefault();const t=await i.requestColourPick(r);!1!==t&&($(e.currentTarget).parent().find('input[type="color"]').val(t).trigger("change"),$(e.currentTarget).parent().find("input.color").val(t).trigger("change"))})),$(t).after(a)}))}))}_rightDownPosition=[0,0];_ignoreRightClick=!1;async _handleMouseDownUp(e){if(this._enabled)if(0===e.button)await this._completeColourRequest();else{if(2!==e.button)return;if("mouseup"===e.type){if(this._ignoreRightClick)return;this._colour=!1,await this._completeColourRequest()}else this._rightDownPosition=[e.x,e.y],2===e.button&&(this._ignoreRightClick=!1)}}async _completeColourRequest(){$(this._html).remove(),$(document.body).css("cursor","");const e=this._colour,t=this._promise;this._promise=null,this._colour="",this._enabled=!1,this._pixels=null,this._currentApp=null;for(let e of this._states)e.minimized||ui.windows[e.id].maximize();this._states=null,t.res(e),this._currentApp?.bringToTop()}_handleMouseMove(e){if(!this._enabled)return;if(2===e.buttons){const t=e.x-this._rightDownPosition[0],a=e.y-this._rightDownPosition[1];Math.sqrt(t*t+a*a)>20&&(this._ignoreRightClick=!0)}const t=canvas.app.renderer.context.renderer.gl;t.readPixels(e.x-this.HALF_SIZE,canvas.app.renderer.height-1-e.y-this.HALF_SIZE,this.SIZE,this.SIZE,t.RGBA,t.UNSIGNED_BYTE,this._pixels);var a="",i=0,r=0;for(let e=0;e<this._pixels.length;e+=4)if(a="#"+((1<<24)+(this._pixels[e]<<16)+(this._pixels[e+1]<<8)+this._pixels[e+2]).toString(16).slice(1),i=e/4%this.SIZE,r=this.SIZE-1-Math.trunc(e/4/this.SIZE),this._rows[r].children[i].style.backgroundColor=a,i==this.HALF_SIZE&&r==this.HALF_SIZE){(this._pixels[e]+this._pixels[e+1]+this._pixels[e+2])/3>128?this._html.style.setProperty("--dfarch-border","#000"):this._html.style.setProperty("--dfarch-border","#fff"),this._colour=a}this._html.style.left=e.x+1+"px",this._html.style.top=e.y+1+"px"}async requestColourPick(e){return new Promise((async(t,a)=>{if(null!=this._promise&&this._promise.res(!1),this._promise={res:t},this._currentApp=e,this._pixels=new Uint8Array(this.SIZE*this.SIZE*4),document.body.appendChild(this._html),null===this._states){const e=[];this._states=[];for(let t of Object.values(ui.windows))t.options.minimizable&&(this._states.push({id:t.appId,minimized:t._minimized}),e.push(t.minimize()));await Promise.all(e)}this._enabled=!0,$(document.body).css("cursor","crosshair")}))}}const i=new _QuickColourPicker;window.EyeDropper={getColor:_QuickColourPicker.prototype.requestColourPick.bind(i)}},(e,t,a)=>{a.r(t),a.d(t,{default:()=>CaptureGameScreen});var i=a(3),r=a(2),n=a(14),l=a(15);const afterDOMUpdate=(e,t=10)=>setTimeout(e,t),waitForDOMUpdate=async(e=10)=>new Promise((t=>afterDOMUpdate(t,e))),DELETE_RESOURCES=e=>{if(e instanceof Array){for(let t of e)if(null!=t)if(t instanceof Array)DELETE_RESOURCES(t);else{if(t.isDeleted())continue;t.delete()}}else null==e||e.isDeleted()||e.delete()};class CaptureGameScreen{static SPLIT_DIM=4096;static WARNING_SIZE=CaptureGameScreen.SPLIT_DIM*CaptureGameScreen.SPLIT_DIM;static PREF_ALLOW_PC="CaptureGameScreen.AllowPC";static PREF_COMP="CaptureGameScreen.Compression";static PREF_FRMT="CaptureGameScreen.Format";static PREF_TRGT="CaptureGameScreen.Target";static PREF_PADS="CaptureGameScreen.Padding";static PREF_LYRS="CaptureGameScreen.Layers";static PREF_BG_HIDE="CaptureGameScreen.BG.Hide";static PREF_BG_COLO="CaptureGameScreen.BG.Colour";static PREF_BG_ALPH="CaptureGameScreen.BG.Alpha";static LayersWithInvisiblePlaceables=["walls","lighting","sounds","templates","notes"];static LayersWithHiddenPlaceables=["background","tokens","drawings","foreground"];static _dialogLayerFilters;static _layerFilters;static _captureInProgress=!1;static _currentSession=null;static _openCVPromise=null;static getLayerState(e){return duplicate(this._layerFilters[e])}static _getDialogLayerFilter(e){return this._dialogLayerFilters[e]||(this._dialogLayerFilters[e]={s:!0}),this._dialogLayerFilters[e]}static init(){r.default.register(this.PREF_ALLOW_PC,{name:"DF_ARCHITECT.CaptureGameScreen.Setting.AllowPC_Name",hint:"DF_ARCHITECT.CaptureGameScreen.Setting.AllowPC_Hint",scope:"world",config:!0,type:Boolean,default:!1}),r.default.register(this.PREF_COMP,{scope:"client",config:!1,type:Number,default:.95}),r.default.register(this.PREF_FRMT,{scope:"client",config:!1,type:String,default:"png"}),r.default.register(this.PREF_TRGT,{scope:"client",config:!1,type:String,default:"all"}),r.default.register(this.PREF_PADS,{scope:"client",config:!1,type:Boolean,default:!1}),r.default.register(this.PREF_LYRS,{scope:"client",config:!1,type:Object,default:{}}),r.default.register(this.PREF_BG_HIDE,{scope:"client",config:!1,type:Boolean,default:!1}),r.default.register(this.PREF_BG_COLO,{scope:"client",config:!1,type:String,default:"#999999"}),r.default.register(this.PREF_BG_ALPH,{scope:"client",config:!1,type:Number,default:100}),this._dialogLayerFilters=r.default.get(this.PREF_LYRS),Hooks.on("renderSettings",((e,t,a)=>{if(!r.default.get(this.PREF_ALLOW_PC)&&!game.user.isGM)return;const i=$(`<div><button data-action="screen-capture"><i class="fas fa-camera"></i>${"DF_ARCHITECT.CaptureGameScreen.ScreenCapture.Label".localize()}</button></div>`);i.find("button").on("click",(()=>ui.notifications.warn("Canvas Capture is temporarily unavailable until the layer filtering feature can be fixed"))),t.find("#game-details").after(i)})),Handlebars.registerHelper("add",((e,t)=>e+t)),libWrapper.register(i.default.MOD_NAME,"Tile.prototype.refresh",(function(e,...t){return CaptureGameScreen._captureInProgress?n.default.bind(this)():e(...t)}),"MIXED"),libWrapper.register(i.default.MOD_NAME,"Drawing.prototype.refresh",(function(e,...t){return CaptureGameScreen._captureInProgress?l.default.bind(this)():e(...t)}),"MIXED")}static async promptForCapture(){if(!game.scenes.viewed)return void ui.notifications.warn("DF_ARCHITECT.CaptureGameScreen.ScreenCapture.WarningNoScene".localize());const layerToConfig=(e,t)=>{var a=("LAYERS."+e).localize();return a.startsWith("LAYERS.")&&(a="LAYERS.unknown".localize().replace("{0}",e[0].titleCase())),{label:a,name:e,active:"notes"!==e?t._active:t._active||game.settings.get("core",t.constructor.TOGGLE_SETTING),hasControls:this.LayersWithInvisiblePlaceables.includes(e),hasHidden:this.LayersWithHiddenPlaceables.includes(e),filter:mergeObject({s:!0,h:!1,c:!1},this._getDialogLayerFilter(e))}},e={isGM:game.user.isGM,compression:r.default.get(this.PREF_COMP),png:"png"===r.default.get(this.PREF_FRMT),jpeg:"jpeg"===r.default.get(this.PREF_FRMT),webp:"webp"===r.default.get(this.PREF_FRMT),all:"all"===r.default.get(this.PREF_TRGT),pads:r.default.get(this.PREF_PADS),layers:Object.keys(CONFIG.Canvas.layers).filter((e=>{const t=!!CONFIG.Canvas.layers[e].layerClass,a="Invalid layer registration '{name}'. This may be from a module that has not been updated for FoundryVTT V9+. You will need to disable the module providing this layer in order to prevent it being visible in any renders.";if(!t){const t="function"==typeof CONFIG.Canvas.layers.simplefog&&CONFIG.Canvas.layers[e].name?CONFIG.Canvas.layers[e].name:e;console.warn(a.replace("{name}",t))}return t})).map((e=>layerToConfig(e,CONFIG.Canvas.layers[e].layerClass.instance))),bg:{hide:r.default.get(this.PREF_BG_HIDE),alph:r.default.get(this.PREF_BG_ALPH),colo:r.default.get(this.PREF_BG_COLO)}};canvas.background.bg&&(canvas.background.bg.visible=!e.bg.hide),canvas.app.renderer.backgroundColor=parseInt(e.bg.colo.slice(1),16),canvas.app.renderer.backgroundAlpha=e.bg.alph/100;const t=this.beginCapture(!1);if(!t)return void ui.notifications.warn("DF_ARCHITECT.CaptureGameScreen.ErrorCaptureInProgress".localize());var a=!1;const n=new Dialog({title:"DF_ARCHITECT.CaptureGameScreen.ScreenCapture.Label".localize(),content:await renderTemplate(`modules/${i.default.MOD_NAME}/templates/capture-board.hbs`,e),default:"save",buttons:{cancel:{icon:'<i class="fas fa-times"></i>',label:"DF_ARCHITECT.General.Cancel".localize(),callback:()=>{a=!0,this.endCapture(t)}},save:{icon:'<i class="fas fa-camera"></i>',label:"DF_ARCHITECT.CaptureGameScreen.ScreenCapture.ContinueButton".localize(),callback:async e=>{a=!0,e=$(e);var i="";e.find('input[name="target"]').each(((e,t)=>{t.checked&&(i=$(t).val())}));const l=e.find('input[name="padding"]')[0].checked,s=parseFloat(e.find("#compression").val()),o="all"===i?this.captureCanvas:this.captureView,c=e.find("#format").val();var d;await Promise.all([r.default.set(this.PREF_COMP,s),r.default.set(this.PREF_FRMT,c),r.default.set(this.PREF_TRGT,i),r.default.set(this.PREF_PADS,l)]),await n.close();try{d=await o({format:"image/"+c,compression:s,keepPadding:l})}catch(e){return void console.warn(e)}finally{this.endCapture(t)}await this.saveImageData({image:d})}}},close:()=>{a||this.endCapture(t)},render:e=>{const t=$(e),a=t.find("#compression"),n=t.find("#compr-out");a.on("change",(()=>n.html(a.val()))),a.on("input",(()=>a.trigger("change"))),t.find("#filter-reset").on("click",(e=>{e.preventDefault(),Object.entries(this._dialogLayerFilters).forEach((e=>{var[t,a]=e;a.s||(this.toggleLayer(t,!0),a.s=!0),a.h&&(this.toggleHidden(t,!1),a.h=!1),a.c&&(this.toggleControls(t,!1),a.c=!1)})),t.find(".dfarch-capture-form section>div>input").each(((e,t)=>{const a=t;a.id.endsWith("-show")?a.checked=!0:a.checked=!1}))})),t.find(".dfarch-capture-form section>div>input").on("change",(async e=>{const t=e.currentTarget;t.id.endsWith("-show")?(this._getDialogLayerFilter(t.value).s=t.checked,this.toggleLayer(t.value,t.checked)):t.id.endsWith("-hidden")?(this._getDialogLayerFilter(t.value).h=t.checked,this.toggleHidden(t.value,t.checked)):(this._getDialogLayerFilter(t.value).c=t.checked,this.toggleControls(t.value,t.checked)),await r.default.set(this.PREF_LYRS,this._dialogLayerFilters)})),t.find("#bg-hide").on("change",(e=>{const t=e.currentTarget.checked;canvas.background.bg&&(canvas.background.bg.visible=!t),r.default.set(this.PREF_BG_HIDE,t)})),t.find("#bg-colo").on("change",(e=>{const t=e.currentTarget.value;canvas.app.renderer.backgroundColor=parseInt(t.slice(1),16),r.default.set(this.PREF_BG_COLO,t)}));const l=t.find("#bg-alph"),s=t.find("#bg-alph-out")[0];l.on("change",(e=>{const t=e.currentTarget;s.value=`${t.value}%`;const a=parseInt(t.value);isNaN(a)||(canvas.app.renderer.backgroundAlpha=a/100,r.default.set(this.PREF_BG_ALPH,a))})),l.on("input",(()=>l.trigger("change"))),t.find("#bg-colo-reset").on("click",(e=>{e.preventDefault(),t.find("#bg-colo").val(game.scenes.viewed.data.backgroundColor).trigger("change")})),Object.entries(this._dialogLayerFilters).forEach((e=>{var[t,a]=e;null!==i.default.getLayer(t)?(this.toggleLayer(t,a.s),a.h&&this.toggleHidden(t,!0),a.c&&this.toggleControls(t,!0)):delete this._dialogLayerFilters[t]}))}});n.render(!0)}static async loadOpenCV(){return null==this._openCVPromise&&(this._openCVPromise=new Promise((e=>{var t=document.createElement("script");t.id="opencv",t.async=!0,t.onload=()=>{cv.getBuildInformation?e():cv.onRuntimeInitialized=()=>e()},t.src=`/modules/${i.default.MOD_NAME}/libs/opencv.js`,document.body.append(t)}))),this._openCVPromise}static beginCapture(e=!0){if(CaptureGameScreen._captureInProgress){if(e)throw Error("Capture In Progress");return null}CaptureGameScreen._captureInProgress=!0,this._layerFilters={};for(const e of Object.keys(CONFIG.Canvas.layers))this._layerFilters[e]={s:!0};const t=[],a=[];for(let e of this.LayersWithHiddenPlaceables){const r=i.default.getLayer(e);for(let e of r.objects.children)void 0!==e.frame?e.frame.visible=!1:void 0!==e.border&&(e.border.visible=!1),e instanceof Tile&&e.data.occlusion.mode!==CONST.TILE_OCCLUSION_MODES.NONE&&(e.data.flags.df_arch_occl=e.data.occlusion.mode,e.data.occlusion.mode=CONST.TILE_OCCLUSION_MODES.NONE,a.push(e)),void 0!==e.data.hidden&&e.data.hidden&&(e.data.hidden=!1,e.data.flags.df_arch_hidden=!0,t.push(e),e.refresh(),e.visible=!1)}const r=canvas.foreground._active;return CaptureGameScreen._currentSession={hiddenItemsSnapshot:t,occludedItemsSnapshot:a,foregroundPreviouslyActive:r,id:(new Date).getTime()},CaptureGameScreen._currentSession}static async endCapture(e){if(!CaptureGameScreen._captureInProgress)return!1;if(null===e||e.id!==CaptureGameScreen._currentSession?.id)return!1;CaptureGameScreen._captureInProgress=!1,this._layerFilters={},canvas.background.bg&&(canvas.background.bg.visible=!0),canvas.app.renderer.backgroundColor=parseInt(game.scenes.viewed.data.backgroundColor.slice(1),16),canvas.app.renderer.backgroundAlpha=1;for(let t of e.hiddenItemsSnapshot)t.data.hidden=!0,t.visible=!0,delete t.data.flags.df_arch_hidden;for(let t of e.occludedItemsSnapshot)t.data.occlusion.mode=t.data.flags.df_arch_occl,delete t.data.flags.df_arch_occl;for(let e of Object.keys(CONFIG.Canvas.layers)){const t=i.default.getLayer(e);if(this.LayersWithHiddenPlaceables.includes(e))for(let e of t.objects.children)void 0!==e.frame?e.frame.visible=!0:void 0!==e.border&&(e.border.visible=!0);if(t.renderable=!0,t.deactivate(),"NotesLayer"===t.name){const e=game.settings.get("core",t.constructor.TOGGLE_SETTING);t.objects&&(t.objects.visible=e,t.placeables.forEach((t=>t.controlIcon.visible=e))),t.interactiveChildren=e}}const t=ui.controls.activeControl,a=ui.controls.controls.find((e=>e.name===t));return a&&a.layer&&canvas[a.layer].activate(),await waitForDOMUpdate(),e.foregroundPreviouslyActive&&canvas.foreground.activate(),!0}static toggleLayer(e,t){if(this._captureInProgress){var a=i.default.getLayer(e);a?(a.renderable=t,e in this._layerFilters?this._layerFilters[e].s=t:this._layerFilters[e]={s:t}):console.error(`CaptureGameScreen::toggleLayer() - There is no registered layer for the name '${e}'. Attempting to find layer in layer list manually.`)}else console.error("Layer toggling requires a Capture Session to be started. Please call `beginCapture()` first.")}static toggleHidden(e,t){if(!this._captureInProgress)return void console.error("Hidden Placeables toggling requires a Capture Session to be started. Please call `beginCapture()` first.");i.default.getLayer(e).objects.children.forEach((e=>{e.data.flags.df_arch_hidden&&(e.visible=t)})),e in this._layerFilters?this._layerFilters[e].h=t:this._layerFilters[e]={s:!0,h:t}}static toggleControls(e,t){if(!this._captureInProgress)return void console.error("Controls toggling requires a Capture Session to be started. Please call `beginCapture()` first.");const a=i.default.getLayer(e);this._getDialogLayerFilter(e).c=t,"TemplateLayer"===a.name?t?a.objects&&a.placeables.forEach((e=>{try{e.hud.children.forEach((e=>e.visible=!0))}catch(e){console.error(e)}})):a.objects&&(a.objects.visible=!0,a.placeables.forEach((e=>{try{e.hud.children.forEach((e=>e.visible=!1))}catch(e){console.error(e)}}))):"NotesLayer"===a.name?t?a.objects&&(a._active=!0,a.objects.visible=!0,a.placeables.forEach((e=>e.controlIcon.visible=!0))):a.objects&&(a._active=!1,a.objects.visible=!1,a.placeables.forEach((e=>e.controlIcon.visible=!1))):t?(a._active=!0,a.objects.visible=!0,a.placeables.forEach((e=>e.refresh()))):(a._active=!1,a.objects.visible=!1,a.releaseAll(),a.placeables.forEach((e=>e.refresh())),a.preview&&a.preview.removeChildren()),e in this._layerFilters?this._layerFilters[e].c=t:this._layerFilters[e]={s:!0,c:t}}static async captureView({format:e,quality:t}){return canvas=canvas,await CaptureGameScreen.captureCanvas({format:e,quality:t,view:{x:canvas.stage.pivot.x,y:canvas.stage.pivot.y,w:canvas.app.renderer.width,h:canvas.app.renderer.height,s:canvas.stage.scale.x}})}static async captureCanvas({format:e,quality:t,keepPadding:a,view:r}){const n=new Image,l=document.createElement("canvas"),s=l.getContext("2d");s.imageSmoothingEnabled=!1;const GetImageMat=e=>new Promise(((t,a)=>{n.onload=()=>{l.width=n.width,l.height=n.height,s.drawImage(n,0,0),t(cv.imread(l))},n.src=e})),GetImageData=a=>(cv.imshow(l,a),l.toDataURL(e,t));return new Promise((async(t,n)=>{const l=$(`<div id="dfarch-temp-overlay"><h1>${"DF_ARCHITECT.CaptureGameScreen.ScreenCapture.Rendering".localize()}...</h1><div class="dfarch-dual-ring"></div></div>`);if(l.appendTo(document.body),await CaptureGameScreen.loadOpenCV(),!canvas.foreground._active&&CaptureGameScreen._layerFilters.foreground.s){canvas.foreground.activate();for(const e of Object.keys(CaptureGameScreen._layerFilters))CaptureGameScreen._layerFilters[e].s&&CaptureGameScreen._layerFilters[e].c&&CaptureGameScreen.toggleControls(e,!0);const e=t,a=n;t=t=>{canvas.foreground.deactivate(),e(t)},n=e=>{canvas.foreground.deactivate(),a(e)}}await waitForDOMUpdate(100);const s=canvas.stage.pivot.x,o=canvas.stage.pivot.y,c=canvas.stage.scale.x,d=canvas.app.renderer.width,h=canvas.app.renderer.height,u=canvas.app.renderer.resolution;canvas.app.renderer.resolution=1;const g=$(document.body);var p=canvas.scene.data.padding*canvas.scene.data.width,_=canvas.scene.data.padding*canvas.scene.data.height;p%canvas.grid.size!=0&&(p=(Math.trunc(p/canvas.grid.size)+1)*canvas.grid.size),_%canvas.grid.size!=0&&(_=(Math.trunc(_/canvas.grid.size)+1)*canvas.grid.size),void 0===r?r={x:0,y:0,w:(a?2*p:0)+canvas.scene.data.width,h:(a?2*_:0)+canvas.scene.data.height,s:1}:(r.x-=p,r.y-=_);const f=(g.width()-r.w)/2,m=(g.height()-r.h)/2,C=[Math.ceil(r.w/CaptureGameScreen.SPLIT_DIM),Math.ceil(r.h/CaptureGameScreen.SPLIT_DIM)],E=Math.ceil(r.w/C[0]),y=r.w-E*(C[0]-1),b=Math.ceil(r.h/C[1]),v=r.h-b*(C[1]-1);if(r.w*r.h>CaptureGameScreen.WARNING_SIZE){if(!await Dialog.confirm({title:"DF_ARCHITECT.CaptureGameScreen.ScreenCapture.WarningConfirmTitle".localize(),content:"DF_ARCHITECT.CaptureGameScreen.ScreenCapture.WarningConfirmContent".localize(),defaultYes:!0}))return l.remove(),void n("User Cancelled")}const T=$("canvas#board"),S=[];try{const e=1!=r.s?Math.floor(C[0]/2):C[0]/2,t=1!=r.s?Math.floor(C[1]/2):C[1]/2;for(let n=0;n<C[1];n++){const l=n;for(let n=0;n<C[0];n++){const s=n;i.default.reportProgress("DF_ARCHITECT.CaptureGameScreen.ScreenCapture.Rendering".localize(),l*C[0]+s,C[0]*C[1]),canvas=canvas;var R=0,A=0,L=r.x+f+(a?0:p)+E*(s+e),w=r.y+m+(a?0:_)+b*(l+t);C[0]>1&&s==C[0]-1?(R=y,L-=(E-y)/2):R=E,C[1]>1&&l==C[1]-1?(A=v,w-=(b-v)/2):A=b,canvas.app.renderer.resize(R,A),canvas.stage.scale.set(r.s),canvas.stage.pivot.set(L,w),T.css("width",R+"px"),T.css("height",A+"px"),await waitForDOMUpdate(),S.push({data:canvas.app.renderer.context.renderer.extract.base64(null,"image/png",1),width:R,height:A})}}}catch(e){return i.default.hideProgress(),void n(e)}if(i.default.reportProgress("DF_ARCHITECT.CaptureGameScreen.ScreenCapture.Rendering".localize(),C[0]*C[1],C[0]*C[1],!0),canvas.app.renderer.resolution=u,T.css("width",d+"px"),T.css("height",h+"px"),canvas.app.renderer.resize(d,h),canvas.stage.scale.set(c),canvas.stage.pivot.set(s,o),l.find("h1").text("DF_ARCHITECT.CaptureGameScreen.ScreenCapture.Stitching".localize()+"..."),afterDOMUpdate((()=>l.remove())),1==S.length){if("image/png"!=e){const e=await GetImageMat(S[0].data);t({data:GetImageData(e),width:e.cols,height:e.rows})}else t(S[0]);return void i.default.hideProgress()}const D=[];var F,I;try{F=new cv.MatVector;for(let e=0;e<C[1];e++){if(i.default.reportProgress("DF_ARCHITECT.CaptureGameScreen.ScreenCapture.Stitching".localize(),e,C[1]),await waitForDOMUpdate(),1===C[0]){D.push(await GetImageMat(S[e].data)),F.push_back(D[e]),console.log(D[e].size());continue}const t=new cv.MatVector,a=[];var P;try{for(let i=0;i<C[0];i++)P=await GetImageMat(S[e*C[0]+i].data),a.push(P),t.push_back(P);P=new cv.Mat,cv.hconcat(t,P),console.log(P.size()),D.push(P),F.push_back(P)}finally{DELETE_RESOURCES([t,a])}}}catch(e){return console.error("Failed to complete image stitching!",e),DELETE_RESOURCES([F,D]),ui.notifications.error("DF_ARCHITECT.CaptureGameScreen.ScreenCapture.ErrorStitchingFailure".localize(),{permanent:!0}),i.default.hideProgress(),void n(e)}i.default.reportProgress("DF_ARCHITECT.CaptureGameScreen.ScreenCapture.Stitching".localize(),C[1],C[1]),await waitForDOMUpdate();try{if(1==D.length)return t({data:GetImageData(D[0]),width:D[0].cols,height:D[0].rows}),void DELETE_RESOURCES([F,D]);I=new cv.Mat;let e=cv.vconcat(F,I);console.log(e),console.log(I.size()),DELETE_RESOURCES([F,D]),t({data:GetImageData(I),width:I.cols,height:I.rows})}catch(e){console.error("Failed to complete image stitching!",e),ui.notifications.error("DF_ARCHITECT.CaptureGameScreen.ScreenCapture.ErrorStitchingFailure".localize(),{permanent:!0}),n(e)}finally{i.default.hideProgress(),DELETE_RESOURCES([F,D,I])}}))}static saveImageData({image:e,dialogTitle:t,defaultFileName:a,folder:r,folderSource:n,allowDownload:l}){return new Promise((async s=>{var o=!1;const resolve=e=>{o||(o=!0,s(e))};var c=!1;const d=(new Date).toISOString().replace(/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}).+/,"$3$4$5$6"),h={cancel:{icon:'<i class="fas fa-times"></i>',label:"DF_ARCHITECT.General.Cancel".localize(),callback:()=>{_.close()}},local:{icon:'<i class="fas fa-download"></i>',label:"DF_ARCHITECT.CaptureGameScreen.SaveImageDialog.SaveLocal".localize(),callback:t=>{const a=(t=t instanceof HTMLElement?$(t):t).find("#filename")[0],i=document.createElement("a");i.href=e.data,i.download=a.value||a.placeholder,i.click(),resolve(null)}},server:{icon:'<i class="fas fa-upload"></i>',label:"DF_ARCHITECT.CaptureGameScreen.SaveImageDialog.SaveServer".localize(),callback:async a=>{c=!0;const l=(a=a instanceof HTMLElement?$(a):a).find("#filename")[0],s=l.value||l.placeholder,d=e.data.match(/^data:(.+);base64,(.+)/),h=i.default.Base64ToBlob(d[2],d[1]),u=new File([h],s,{});if(!r){const e=await new Promise((e=>{const a=new FilePicker({title:t,type:"folder",folderSource:n||"data",callback:async t=>{o=!0,n=a.activeSource,r=t,e({path:t,source:a.activeSource})}}),i=a.close;a.close=t=>(e({path:null,source:null}),i.bind(a).call(t)),a.browse("")}));if(!e.path)return void resolve(null);r=e.path,n=e.source}await FilePicker.upload(n,r,u),resolve(r+"/"+s)}}};!1==!l&&delete h.local;const u=t||"DF_ARCHITECT.CaptureGameScreen.SaveImageDialog.Title".localize(),g=e.data.slice(0,20).match(/data:image\/(.+);/)[1],p=await renderTemplate(`modules/${i.default.MOD_NAME}/templates/tile-flatten-save.hbs`,{format:g,placeholder:(a||"DF_ARCHITECT.CaptureGameScreen.SaveImageDialog.DefaultFileName".localize())+"-"+d}),_=new Dialog({title:u,content:p,close:()=>{c||resolve(void 0)},buttons:h,default:"server",render:t=>{const a=$(t).find("#img-preview")[0];a.onload=()=>{_.setPosition({height:"auto"});const e=(window.innerHeight-_.element[0].offsetHeight)/2,t=Math.max(window.innerHeight-_.element[0].offsetHeight,0);_.setPosition({top:Math.clamped(e,0,t)})},a.src=e.data}},{width:500});_.render(!0)}))}}window.CanvasCapture={LayersWithInvisiblePlaceables:CaptureGameScreen.LayersWithInvisiblePlaceables,LayersWithHiddenPlaceables:CaptureGameScreen.LayersWithHiddenPlaceables,beginCapture:CaptureGameScreen.beginCapture.bind(CaptureGameScreen),endCapture:CaptureGameScreen.endCapture.bind(CaptureGameScreen),render:CaptureGameScreen.captureCanvas.bind(CaptureGameScreen),toggleLayer:CaptureGameScreen.toggleLayer.bind(CaptureGameScreen),toggleHidden:CaptureGameScreen.toggleHidden.bind(CaptureGameScreen),toggleControls:CaptureGameScreen.toggleControls.bind(CaptureGameScreen),saveImageData:CaptureGameScreen.saveImageData.bind(CaptureGameScreen)}},(e,t,a)=>{async function __WEBPACK_DEFAULT_EXPORT__(){const e=Math.abs(this.data.width),t=Math.abs(this.data.height),a=Math.toRadians(this.data.rotation);this.position.set(this.data.x,this.data.y),this.tile&&(this.tile.scale.x=this.data.width/this.texture.width,this.tile.scale.y=this.data.height/this.texture.height,this.tile.position.set(e/2,t/2),this.tile.rotation=a,this.tile.alpha=1,this.tile.tint=this.data.tint?foundry.utils.colorStringToHex(this.data.tint):16777215),this.bg&&this.bg.clear().beginFill(16777215,.5).drawRect(0,0,e,t).endFill();let i=e===t?new NormalizedRectangle(0,0,e,t):NormalizedRectangle.fromRotation(0,0,e,t,a);return this.hitArea=this._controlled?i.clone().pad(20):i,this._refreshBorder(i),this._refreshHandle(i),this}a.r(t),a.d(t,{default:()=>__WEBPACK_DEFAULT_EXPORT__})},(e,t,a)=>{async function __WEBPACK_DEFAULT_EXPORT__(){if(this._destroyed||this.shape._destroyed)return;const e=this.data.type===CONST.DRAWING_TYPES.TEXT&&this._controlled;if(this.shape.clear(),this.data.strokeWidth||e){let t=foundry.utils.colorStringToHex(this.data.strokeColor||"#FFFFFF");const a=e?8:this.data.strokeWidth??8;this.shape.lineStyle(a,t,this.data.strokeAlpha??1)}if(this.data.fillType||e){const t=foundry.utils.colorStringToHex(this.data.fillColor||"#FFFFFF");if(this.data.fillType===CONST.DRAWING_FILL_TYPES.PATTERN&&this.texture)this.shape.beginTextureFill({texture:this.texture,color:t||16777215,alpha:t?this.data.fillAlpha:1});else{const a=e?.25:this.data.fillAlpha;this.shape.beginFill(t,a)}}switch(this.data.type){case CONST.DRAWING_TYPES.RECTANGLE:case CONST.DRAWING_TYPES.TEXT:this._drawRectangle();break;case CONST.DRAWING_TYPES.ELLIPSE:this._drawEllipse();break;case CONST.DRAWING_TYPES.POLYGON:this._drawPolygon();break;case CONST.DRAWING_TYPES.FREEHAND:this._drawFreehand()}this.shape.lineStyle(0,0).closePath(),this.shape.endFill(),this.shape.pivot.set(this.data.width/2,this.data.height/2),this.shape.position.set(this.data.width/2,this.data.height/2),this.shape.rotation=Math.toRadians(this.data.rotation||0),this.text&&(this.text.alpha=this.data.textAlpha??1,this.text.pivot.set(this.text.width/2,this.text.height/2),this.text.position.set(this.text.width/2+(this.data.width-this.text.width)/2,this.text.height/2+(this.data.height-this.text.height)/2),this.text.rotation=this.shape.rotation),this.position.set(this.data.x,this.data.y),this.alpha=1}a.r(t),a.d(t,{default:()=>__WEBPACK_DEFAULT_EXPORT__})},(e,t,a)=>{a.r(t),a.d(t,{LightTemplateManager:()=>LightTemplateManager,LightingLayerOverride:()=>LightingLayerOverride});var i=a(3);window.LightTemplates=new class _LightTemplates{async activate(e){if(!game.user.isGM)return;null!==LightTemplateManager.currentActiveTemplate&&this.deactivate(),"lighting"!==ui.controls.activeControl&&$('li.scene-control[data-control="lighting"]').trigger("click"),LightTemplateManager.currentActiveTemplate=e;const t=LightTemplateManager.getCurrentTemplateData();t.config.bright=Math.roundDecimals(t.config.bright,2),t.config.dim=Math.roundDecimals(t.config.dim,2);const a=parseInt("0x1"+(t.config.color||"#000000").substring(1)),r=$(await renderTemplate(`modules/${i.default.MOD_NAME}/templates/cur-light-template.hbs`,{name:game.macros.get(e).name,data:t,colorIntensity:Math.sqrt(t.config.alpha).toNearest(.05),animationType:""===t.config.animation.type?"None":CONFIG.Canvas.lightAnimations[t.config.animation.type].label,tintColorValue:t.config.color||"transparent",tintColorLabel:t.config.color||"#------",tintIsDark:(((16711680&a)>>16)+((65280&a)>>8)+(255&a))/3<128,coloration:Object.entries(AdaptiveLightingShader.SHADER_TECHNIQUES).find((e=>e[1].id===t.config.coloration))[1].label.localize()})),n=$("nav#controls ol.active")[0].getBoundingClientRect();r.css("left",n.right+10+"px"),r.css("top",n.top+"px");const l=r.find("a");l.first().on("click",(()=>game.macros.get(e).sheet.render(!0))),l.last().on("click",this.deactivate.bind(this)),r.appendTo(document.body)}deactivate(){game.user.isGM&&($("#dfarch-cur-light-template").remove(),LightTemplateManager.currentActiveTemplate=null)}};class LightTemplateManager{static FLAG_IS_TEMPLATE="isLightTemplate";static currentActiveTemplate=null;static getCurrentTemplateData(){return null===this.currentActiveTemplate?null:this.extractLightDataFromMacroCommand(game.macros.get(this.currentActiveTemplate).command)}static init(){libWrapper.register(i.default.MOD_NAME,"Hotbar.prototype._getEntryContextOptions",this._getEntryContextOptions.bind(this),"OVERRIDE")}static ready(){game.user.isGM&&(Hooks.on("renderAmbientLightConfig",this._renderLightConfig.bind(this)),Hooks.on("renderMacroConfig",this._renderMacroConfig.bind(this)),Hooks.on("renderSceneControls",(e=>{game.user.isGM&&"lighting"!==e.activeControl&&LightTemplates.deactivate()})),Hooks.on("renderMacroDirectory",((e,t,a)=>{const i=$(`<button style="flex:unset"><i class="far fa-lightbulb"></i>\n${"DF_ARCHITECT.LightTemplate.CreateTemplateButton.MacroDirectory".localize()}</button>`);i.appendTo(t.find("div.header-actions.action-buttons")),i.on("click",(async()=>await this._createTemplate({rotation:0,walls:!0,vision:!1,config:{alpha:.5,angle:0,animation:{intensity:5,reverse:!1,speed:5,type:""},attenuation:.5,bright:15,color:null,coloration:1,contrast:0,darkness:{max:1,min:0},dim:30,luminosity:.5,saturation:0,shadows:0},flags:{}})))})))}static _renderLightConfig(e,t,a){let i;if(e.df_light_template){const a=e.object;t.find('input[name="x"]').parentsUntil("div.tab").remove(),t.find("a.configure-sheet").remove();const r=$(`<header class="sheet-header">\n\t\t\t<img src="${a.macro.img}" data-edit="img" title="${"DF_ARCHITECT.LightTemplate.TemplateConfig.ImageTitle".localize()}" height="64" width="64">\n\t\t\t<h1><input name="name" type="text" value="${a.macro.name}" placeholder=" Name"></h1>\n\t\t</header>`);r.find("img").on("click",((t,i)=>{new FilePicker({type:"image",current:a.macro.data.img,callback:e=>{t.target.src=e,a.macro.data.img=e},top:e.position.top+40,left:e.position.left+10}).browse("")})),t.find("nav.sheet-tabs").before(r),t.find('button[name="submit"]').html('<i class="far fa-save"></i> '+"DF_ARCHITECT.LightTemplate.TemplateConfig.SaveButton".localize()),i=$(`<button type="button" class="execute">\n\t<i class="far fa-lightbulb"></i>\n\t${"DF_ARCHITECT.LightTemplate.TemplateConfig.UseButton".localize()}\n\t</button>`),t.find('button[name="submit"]').before(i),i.on("click",(()=>LightTemplates.activate(a.macro.id))),e.element[0].style.height="",e.element[0].style.width="",e.setPosition({width:480})}else i=$(`<button type="button" name="save-template">\n<i class="far fa-lightbulb"></i>\n${"DF_ARCHITECT.LightTemplate.CreateTemplateButton.LightConfig".localize()}\n</button>`),t.find("footer.sheet-footer").prepend(i),i.on("click",(t=>{t.preventDefault(),this._createTemplate(duplicate(e.object.data))}));t.find('a.item[data-tab="advanced"]').hasClass("active")&&i.hide(),t.find('a.item[data-tab="basic"]').on("click",(()=>i.show())),t.find('a.item[data-tab="animation"]').on("click",(()=>i.show())),t.find('a.item[data-tab="advanced"]').on("click",(()=>i.hide()))}static async _renderMacroConfig(e,t,a){const r=a.document;if(!r.getFlag(i.default.MOD_NAME,this.FLAG_IS_TEMPLATE))return;t.remove(),t.toggle,setTimeout((()=>e.close()),10);const n=this.extractLightDataFromMacroCommand(r.command),l=new AmbientLightConfig(new TemplateLightDocument(r,n),{editable:!0});l.df_light_template=!0,l.render(!0,{editable:!0})}static async _createTemplate(e){delete e._id,delete e.x,delete e.y,delete e.hidden,0==e.config.angle&&(e.config.angle=360);const t=await Macro.create({name:"Light Template "+(new Date).toISOString().replace(/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}).+/,"$4$5$6"),author:game.userId,img:"icons/svg/light.svg",scope:"global",type:"script",command:this.generateCommandData(e)});await t.setFlag(i.default.MOD_NAME,this.FLAG_IS_TEMPLATE,!0),t.sheet.render(!0)}static _getEntryContextOptions(){return[{name:"MACRO.Edit",icon:'<i class="fas fa-edit"></i>',condition:e=>{if(e.hasClass("inactive"))return!1;const t=game.macros.get(e.data("macro-id"));return!(!t||t.getFlag(i.default.MOD_NAME,this.FLAG_IS_TEMPLATE))&&t.isOwner},callback:e=>{game.macros.get(e.data("macro-id")).sheet.render(!0)}},{name:"MACRO.Remove",icon:'<i class="fas fa-times"></i>',condition:e=>!e.hasClass("inactive")&&!game.macros.get(e.data("macro-id")).getFlag(i.default.MOD_NAME,this.FLAG_IS_TEMPLATE),callback:e=>game.user.assignHotbarMacro(null,Number(e.data("slot")))},{name:"MACRO.Delete",icon:'<i class="fas fa-trash"></i>',condition:e=>{if(e.hasClass("inactive"))return!1;const t=game.macros.get(e.data("macro-id"));return!(!t||t.getFlag(i.default.MOD_NAME,this.FLAG_IS_TEMPLATE))&&t.isOwner},callback:e=>{const t=game.macros.get(e.data("macro-id"));return Dialog.confirm({title:`${game.i18n.localize("MACRO.Delete")} ${t.name}`,content:`<h4>${game.i18n.localize("AreYouSure")}</h4><p>${game.i18n.localize("MACRO.DeleteWarning")}</p>`,yes:t.delete.bind(t)})}},{name:"DF_ARCHITECT.LightTemplate.ContextMenu.Edit",icon:'<i class="fas fa-edit"></i>',condition:e=>{if(e.hasClass("inactive"))return!1;const t=game.macros.get(e.data("macro-id"));return!(!t||!t.getFlag(i.default.MOD_NAME,this.FLAG_IS_TEMPLATE))&&t.isOwner},callback:e=>game.macros.get(e.data("macro-id")).sheet.render(!0)},{name:"DF_ARCHITECT.LightTemplate.ContextMenu.Remove",icon:'<i class="fas fa-times"></i>',condition:e=>!e.hasClass("inactive")&&game.macros.get(e.data("macro-id")).getFlag(i.default.MOD_NAME,this.FLAG_IS_TEMPLATE),callback:e=>game.user.assignHotbarMacro(null,e.data("slot"))},{name:"DF_ARCHITECT.LightTemplate.ContextMenu.Delete",icon:'<i class="fas fa-trash"></i>',condition:e=>{if(e.hasClass("inactive"))return!1;const t=game.macros.get(e.data("macro-id"));return!(!t||!t.getFlag(i.default.MOD_NAME,this.FLAG_IS_TEMPLATE))&&t.isOwner},callback:e=>{const t=game.macros.get(e.data("macro-id"));return Dialog.confirm({title:`${game.i18n.localize("DF_ARCHITECT.LightTemplate.Delete.Title")} ${t.name}`,content:game.i18n.localize("DF_ARCHITECT.LightTemplate.Delete.Confirm"),yes:()=>t.delete()})}}]}static generateCommandData(e){return`const ld=${JSON.stringify(e,null,"")};\nLightTemplates.activate(this.id,ld);`}static extractLightDataFromMacroCommand(e){return JSON.parse(/const +ld *= *(.+);/.exec(e)[1])}}class LightingLayerOverride{static ready(){libWrapper.register(i.default.MOD_NAME,"LightingLayer.prototype._onDragLeftStart",this._onDragLeftStart.bind(canvas.lighting),"MIXED"),libWrapper.register(i.default.MOD_NAME,"LightingLayer.prototype._onClickLeft",this._onClickLeft.bind(canvas.lighting),"MIXED"),libWrapper.register(i.default.MOD_NAME,"LightingLayer.prototype._onClickRight",this._onClickRight.bind(canvas.lighting),"MIXED")}static _onClickLeft(e,t){const a=LightTemplateManager.getCurrentTemplateData();if(null===a||!t.data.originalEvent.ctrlKey)return e(t);const i=t.data.origin;canvas.scene.createEmbeddedDocuments(AmbientLight.embeddedName,[mergeObject(a,{x:i.x,y:i.y})],{})}static _onClickRight(e,t){if(null===LightTemplateManager.getCurrentTemplateData()||!t.data.originalEvent.ctrlKey)return e(t);LightTemplates.deactivate()}static _onDragLeftStart(e,t){const a=LightTemplateManager.getCurrentTemplateData();if(null===a)return e(t);const i=t.data.origin,r=new AmbientLightDocument(mergeObject(a,{x:i.x,y:i.y,dim:0,bright:0}),{parent:canvas.scene}),n=new AmbientLight(r);return t.data.preview=this.preview.addChild(n),canvas.effects.lightSources.set(n.sourceId,n.source),canvas.effects.deactivateAnimation(),n.draw()}}class TemplateLightDocument{apps={};macro;_id;x;y;rotation;walls;vision;config;hidden;flags;get uuid(){return this.macro.id}get id(){return this.macro.id}get name(){return this.macro.name}get object(){return this}get isOwner(){return this.macro.isOwner}constructor(e,t){this._id=t._id,this.x=t.x,this.y=t.y,this.rotation=t.rotation,this.walls=t.walls,this.vision=t.vision,this.config=t.config,this.hidden=t.hidden,this.flags=t.flags,this.macro=e}updateSource(){}refresh(){}async update(e){const t=foundry.utils.expandObject(e),a=t.img,i=t.name;delete t.img,delete t.name,await this.macro.update({name:i,img:a,command:LightTemplateManager.generateCommandData(t)})}testUserPermission(e,t,{exact:a=!1}={}){return this.macro.testUserPermission(e,t,{exact:a})}prepareData(){}clone(){return this}toObject(){return this}_onUpdate(e,{_render:t},a){}static metadata={label:"Light Template"}}},(e,t,a)=>{a.r(t),a.d(t,{default:()=>WallChangeType});var i=a(3),r=a(2);class WallChangeType{static META_KEY="WallChangeType.MetaKey";static ready(){r.default.register(WallChangeType.META_KEY,{name:"DF_ARCHITECT.WallChangeType.Setting.MetaKeyName",hint:"DF_ARCHITECT.WallChangeType.Setting.MetaKeyHint",config:!0,scope:"world",choices:{ctrl:"DF_ARCHITECT.WallChangeType.Setting.MetaKey_OptionCtrl",alt:"DF_ARCHITECT.WallChangeType.Setting.MetaKey_OptionAlt"},default:"ctrl",type:String}),libWrapper.register(i.default.MOD_NAME,"SceneControls.prototype._onClickTool",(async(e,t)=>{if(e(t),"ctrl"===r.default.get(WallChangeType.META_KEY)&&!t.ctrlKey)return;if("alt"===r.default.get(WallChangeType.META_KEY)&&!t.altKey)return;const a=canvas.walls._getWallDataFromActiveTool(game.activeTool);if(void 0===a.door?a.door=0:void 0===a.ds&&(a.ds=0),1===canvas.walls.controlled.length)return void await canvas.walls.controlled[0].document.update(a);const i=canvas.walls.controlled.map((e=>mergeObject({_id:e.document._id},a)));await canvas.scene.updateEmbeddedDocuments("Wall",i),canvas.walls.controlled.forEach((e=>e.refresh()))}),"WRAPPER")}}},(e,t,a)=>{a.r(t),a.d(t,{default:()=>WallAltDrop});var i=a(3),r=a(2),n=a(8),l=a(7);class WallAltDrop{static DISTANCE="WallAltDrop.Distance";static _visible=!1;static ring=new PIXI.Graphics;static init(){libWrapper.register(i.default.MOD_NAME,"Wall.prototype._onDragLeftMove",this._handleDragMove.bind(this),"WRAPPER"),libWrapper.register(i.default.MOD_NAME,"Wall.prototype._onDragLeftDrop",this.Wall_handleDragDrop,"WRAPPER"),libWrapper.register(i.default.MOD_NAME,"Wall.prototype._onDragLeftCancel",this._handleDragCancel.bind(this),"WRAPPER")}static ready(){r.default.register(WallAltDrop.DISTANCE,{name:"DF_ARCHITECT.WallAltDrop.Setting.DistanceName",hint:"DF_ARCHITECT.WallAltDrop.Setting.DistanceHint",config:!0,scope:"world",type:Number,default:24,onChange:e=>this._drawCircle(e)});const e=r.default.get(WallAltDrop.DISTANCE);this._drawCircle(e),libWrapper.register(i.default.MOD_NAME,"WallsLayer.prototype._onDragLeftMove",this._handleDragMove.bind(this),"WRAPPER"),libWrapper.register(i.default.MOD_NAME,"WallsLayer.prototype._getWallEndpointCoordinates",((e,t,{snap:a=!0}={})=>(game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.ALT)&&(a=!1,t=WallAltDrop._getClosestPoint(t)?.point??t),e(t,{snap:a}))),"WRAPPER"),libWrapper.register(i.default.MOD_NAME,"WallsLayer.prototype._onDragLeftCancel",this._handleDragCancel.bind(this),"WRAPPER"),n.default.register("WallsLayer.prototype._onDragLeftDrop",this.WallsLayer_onDragLeftDrop)}static _drawCircle(e){this.ring.clear(),this.ring.beginFill(0,0).lineStyle(4,15633958,1,1).drawCircle(0,0,e).endFill()}static async _handleDragMove(e,t){if(e(t),canvas.walls.controlled.length>1)return;const a=t.data;t.data.originalEvent.altKey&&(a.preview||a.object)?this._updateCircle(!0,a.destination):this._updateCircle(!1)}static async Wall_handleDragDrop(e,t){const a=t.data,{destination:i,fixed:r,object:n}=a;await e(t),canvas.walls.controlled.length>1||(WallAltDrop._updateCircle(!1),t.data.originalEvent.altKey&&(this||n)&&WallAltDrop._updateWallSnap(i,r,t,this))}static async WallsLayer_onDragLeftDrop(e,t){const a=t.data,{destination:i,fixed:r,object:n}=a;var l=a.preview;await e(t),"mousemove"!==t.type&&(canvas.walls.controlled.length>1||(WallAltDrop._updateCircle(!1),t.data.originalEvent.altKey&&(this||n)&&(l&&(l=await new Promise(((e,t)=>{var a=0;const waiter=()=>{a+=10,l.data._id?e(game.scenes.viewed.data.walls.find((e=>e.id===canvas.walls.last.id))?.object):a>2e3?e(void 0):setTimeout(waiter,100)};setTimeout(waiter,10)}))),WallAltDrop._updateWallSnap(i,r,t,l??n))))}static async _handleDragCancel(e,t){e(t),this._updateCircle(!1)}static _updateCircle(e,t){e?(this._visible!=e&&canvas.walls.addChild(this.ring),this.ring.setTransform(t.x,t.y).updateTransform()):this._visible!=e&&canvas.walls.removeChild(this.ring),this._visible=e}static _getClosestPoint(e,t){const a=game.scenes.viewed.walls.filter((e=>e.id!=t)),i=r.default.get(this.DISTANCE);return a.map((t=>{const[a,i]=WallsLayer.getClosestEndpoint(e,t.object);return{dist:Math.hypot(a-e.x,i-e.y),point:{x:a,y:i}}})).filter((e=>e.dist<=i)).sort(((e,t)=>e.dist-t.dist))[0]}static async _updateWallSnap(e,t,a,i){const r=this._getClosestPoint(e,i.document._id);if(!r)return i;const n=[r.point.x,r.point.y],s=t?i.coords.slice(2,4):i.coords.slice(0,2),o=t?n.concat(s):s.concat(n);return(game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.CONTROL)&&!l.default.enabled||!game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.CONTROL)&&l.default.enabled)&&(a.data.object.document.c[0]=n[0],a.data.object.document.c[1]=n[1]),o[0]===o[2]&&o[1]===o[3]?(await i.document.delete(),i):(i.layer.last.point=n,i.document._id&&await i.document.update({c:o}),i)}}},(e,t,a)=>{a.r(t),a.d(t,{default:()=>AltLightInverted});var i=a(3);class AltLightInverted{static ready(){libWrapper.register(i.default.MOD_NAME,"LightingLayer.prototype._onDragLeftMove",this._onDragLeftMove.bind(canvas.lighting),"WRAPPER"),Hooks.on("renderAmbientLightConfig",this._renderLightConfig.bind(this))}static _onDragLeftMove(e,t){const a=t.data.preview;return t.data.originalEvent.altKey?a.document.flags["df-architect"]?.inverted||(a.document.flags["df-architect"]={inverted:!0},a.document.config.luminosity=-a.document.config.luminosity):a.document.flags["df-architect"]?.inverted&&(delete a.document.flags["df-architect"],a.document.config.luminosity=-a.document.config.luminosity),e(t)}static _renderLightConfig(e,t,a){const i=$(`<button type="button" style="flex:0;padding-left:8.5px" name="invert-radius" title="${"DF_ARCHITECT.AltLightInverted.InvertLuminosityButton".localize()}"><i class="fas fa-adjust"></i></button>`);t.find('input[name="config.luminosity"]').parent().before(i),i.on("click",(e=>{e.preventDefault();const a=t.find('input[name="config.luminosity"]');a.val(-parseFloat(a.val())),a.trigger("change")}))}}},(e,t,a)=>{a.r(t),a.d(t,{default:()=>WallDirections});var i=a(3),r=a(2);class WallDirections{static PREF_ALLOW_UNSELECTED_INVERT="WallDirections.AllowUnselectedInvert";static init(){try{libWrapper.register(i.default.MOD_NAME,"Wall.prototype.draw",this._onWallDraw,"WRAPPER"),libWrapper.register(i.default.MOD_NAME,"Wall.prototype.refresh",this._onWallRefresh,"WRAPPER"),libWrapper.register(i.default.MOD_NAME,"Wall.prototype.control",this._onControlOrRelease,"WRAPPER"),libWrapper.register(i.default.MOD_NAME,"Wall.prototype.release",this._onControlOrRelease,"WRAPPER"),libWrapper.register(i.default.MOD_NAME,"Wall.prototype._onClickRight2",this._reverseWallDirection,"OVERRIDE")}catch(e){console.error("Could not initialize Wall Direction Labels",e)}}static ready(){r.default.register(WallDirections.PREF_ALLOW_UNSELECTED_INVERT,{scope:"world",name:"DF_ARCHITECT.WallDirections.Setting.AllowUnselectedInvertName",hint:"DF_ARCHITECT.WallDirections.Setting.AllowUnselectedInvertHint",config:!0,type:Boolean,default:!1})}static _onControlOrRelease(e,...t){const a=e(...t);return game.scenes.viewed.walls.has(this.id)&&this.refresh(),a}static async _reverseWallDirection(){if(r.default.get(WallDirections.PREF_ALLOW_UNSELECTED_INVERT)&&!this._controlled)return;const e=this.document;if(e.dir)await this.document.update({dir:1===e.dir?2:1});else{const e=this.document.c.slice(2).concat(this.document.c.slice(0,2));await this.document.update({c:e})}}static async _onWallDraw(e){const t=new PIXI.TextStyle({align:"center",fill:this._getWallColor(),fontSize:12,stroke:0,strokeThickness:2,lineHeight:0});return this.dfArchWallExt={leftLabel:new PIXI.Text("L",t),rightLabel:new PIXI.Text("R",t),drawLabels:!0,style:t},e()}static _onWallRefresh(e){if(this.dfArchWallExt.drawLabels&&(delete this.dfArchWallExt.drawLabels,this.dfArchWallExt.style.fill=this._getWallColor(),this.addChild(this.dfArchWallExt.leftLabel),this.addChild(this.dfArchWallExt.rightLabel)),e(),!this.controlled||this.document.dir)return this.dfArchWallExt?.leftLabel&&(this.dfArchWallExt.leftLabel.renderable=!1),this.dfArchWallExt?.rightLabel&&(this.dfArchWallExt.rightLabel.renderable=!1),this;const[t,a]=this.document.c.slice(0,2),[i,r]=this.document.c.slice(2),[n,l]=[(t+i)/2,(a+r)/2],[s,o]=[-(r-a),i-t],c=Math.hypot(s,o),[d,h]=[s/c,o/c],[u,g]=[n-10*d,l-10*h],[p,_]=[10*d+n,10*h+l];return this.dfArchWallExt.leftLabel.x=u-this.dfArchWallExt.leftLabel.width/2,this.dfArchWallExt.leftLabel.y=g-this.dfArchWallExt.leftLabel.height/2,this.dfArchWallExt.leftLabel.style.fill=this._getWallColor(),this.dfArchWallExt.leftLabel.renderable=!0,this.dfArchWallExt.rightLabel.x=p-this.dfArchWallExt.rightLabel.width/2,this.dfArchWallExt.rightLabel.y=_-this.dfArchWallExt.rightLabel.height/2,this.dfArchWallExt.rightLabel.style.fill=this._getWallColor(),this.dfArchWallExt.rightLabel.renderable=!0,this}}},(e,t,a)=>{a.r(t),a.d(t,{default:()=>DataMigration});var i=a(2);class DataMigration{static PREF_DATA_VERSION="data-version";static previous;static current;static init(){i.default.register(this.PREF_DATA_VERSION,{scope:"world",config:!1,type:Object,default:{core:"0.0.0",arch:"0.0.0"}})}static async ready(){this.current={core:game.version,arch:game.modules.get("df-architect").version},this.previous=i.default.get(this.PREF_DATA_VERSION),this.current.core===this.previous.core&&this.current.arch===this.previous.arch||(await this.performMigration(),await i.default.set(this.PREF_DATA_VERSION,this.current))}static async performMigration(){var e=!1;e&&ui.notifications.info(game.i18n.localize("DF Architect has finished migrating your data!"),{permanent:!0})}}},(e,t,a)=>{a.r(t),a.d(t,{default:()=>TileFlattener});var i,r=a(3),n=a(2),l=a(13),s=a(23);!function(e){e[e.Floor=0]="Floor",e[e.Roof=1]="Roof",e[e.Both=2]="Both"}(i||(i={}));class TileFlattener{static PREF_RENDER_LIGHT="TileFlattener.RenderLighting";static PREF_RENDER_BACKG="TileFlattener.RenderBackground";static PREF_RENDER_SLCTD="TileFlattener.RenderSelectedOnly";static PREF_RENDER_HIDEN="TileFlattener.RenderHiddenTiles";static PREF_RENDER_ANIMS="TileFlattener.RenderAnimatedTiles";static PREF_MARGIN="TileFlattener.Margin";static PREF_LAYERS="TileFlattener.Layers";static PREF_FOLDER="TileFlattener.Folder";static PREF_FOLDER_SOURCE="TileFlattener.FolderSource";static get renderLights(){return n.default.get(this.PREF_RENDER_LIGHT)}static get renderBackground(){return n.default.get(this.PREF_RENDER_BACKG)}static get renderSelected(){return n.default.get(this.PREF_RENDER_SLCTD)}static get renderHidden(){return n.default.get(this.PREF_RENDER_HIDEN)}static get renderAnimated(){return n.default.get(this.PREF_RENDER_ANIMS)}static get margin(){return n.default.get(this.PREF_MARGIN)}static get layers(){return n.default.get(this.PREF_LAYERS)}static get folder(){return n.default.get(this.PREF_FOLDER)}static get folderSource(){return n.default.get(this.PREF_FOLDER_SOURCE)}static init(){n.default.register(this.PREF_RENDER_LIGHT,{scope:"client",config:!1,type:Boolean,default:!1}),n.default.register(this.PREF_RENDER_BACKG,{scope:"client",config:!1,type:Boolean,default:!0}),n.default.register(this.PREF_RENDER_SLCTD,{scope:"client",config:!1,type:Boolean,default:!1}),n.default.register(this.PREF_RENDER_HIDEN,{scope:"client",config:!1,type:Boolean,default:!1}),n.default.register(this.PREF_RENDER_ANIMS,{scope:"client",config:!1,type:Boolean,default:!1}),n.default.register(this.PREF_LAYERS,{scope:"client",config:!1,type:Number,default:0}),n.default.register(this.PREF_MARGIN,{scope:"client",config:!1,type:n.default.typeOf(),default:{l:0,r:0,t:0,b:0}}),n.default.register(this.PREF_FOLDER,{scope:"world",config:!1,type:String,default:"assets"}),n.default.register(this.PREF_FOLDER_SOURCE,{scope:"world",config:!1,type:String,default:"data"}),n.default.registerMenu("TileFlattener.StorageLocation",{restricted:!0,type:s.default,icon:"fas fa-folder-open",label:"DF_ARCHITECT.TileFlattener.ImageFolderTitle"}),Hooks.on("getSceneControlButtons",(e=>{e.find((e=>"tiles"===e.name)).tools.push({icon:"fas fa-file-image",name:"flatten",button:!0,title:"DF_ARCHITECT.TileFlattener.Label",onClick:()=>ui.notifications.warn("Tile Flattener is temporarily unavailable until the Canvas Capture's layer filtering feature can be fixed")})}))}static async promptForTileFlattening(){const e={png:"png"===n.default.get(l.default.PREF_FRMT),jpeg:"jpeg"===n.default.get(l.default.PREF_FRMT),webp:"webp"===n.default.get(l.default.PREF_FRMT),compression:n.default.get(l.default.PREF_COMP),margin:this.margin,lights:this.renderLights,showBG:this.renderBackground,select:this.renderSelected,hidden:this.renderHidden,layers:this.layers,hideAnimated:this.renderAnimated},t=new Dialog({title:"DF_ARCHITECT.TileFlattener.CapturePromptTitle".localize(),content:await renderTemplate(`modules/${r.default.MOD_NAME}/templates/tile-flatten.hbs`,e),buttons:{cancel:{icon:'<i class="fas fa-times"></i>',label:"DF_ARCHITECT.General.Cancel".localize(),callback:()=>t.close()},capture:{icon:'<i class="fas fa-file-image"></i>',label:"DF_ARCHITECT.TileFlattener.FlattenButton".localize(),callback:this.flattenTiles.bind(this)}},render:this.setupBindings.bind(this),default:"capture"});t.render(!0)}static async flattenTiles(e){const t=(e=e instanceof HTMLElement?e:e[0]).querySelector("#format").value,a=e.querySelector("#compression").valueAsNumber,r={l:e.querySelector("#left").valueAsNumber,r:e.querySelector("#right").valueAsNumber,t:e.querySelector("#top").valueAsNumber,b:e.querySelector("#bottom").valueAsNumber},s=e.querySelector("#lights").checked,o=e.querySelector("#showBG").checked,c=e.querySelector("#hidden").checked,d=!e.querySelector("#animated").checked,h=e.querySelector("#tiles").checked,u=e.querySelector("#floor").checked?i.Floor:e.querySelector("#roof").checked?i.Roof:i.Both;await Promise.all([n.default.set(this.PREF_RENDER_LIGHT,s),n.default.set(this.PREF_RENDER_BACKG,o),n.default.set(this.PREF_RENDER_HIDEN,c),n.default.set(this.PREF_RENDER_ANIMS,d),n.default.set(this.PREF_RENDER_SLCTD,h),n.default.set(this.PREF_MARGIN,r),n.default.set(this.PREF_RENDER_LIGHT,s),n.default.set(this.PREF_LAYERS,u),n.default.set(l.default.PREF_FRMT,t),n.default.set(l.default.PREF_COMP,a)]);const g=new Map;var p;if(p=canvas.background.controlled.concat(canvas.foreground.controlled),h){if(0===p.length)return ui.notifications.error("You must have tiles selected for the current configuration. Did you maybe mean to select Entire Canvas?".localize()),void this.promptForTileFlattening();const e=canvas.background.tiles.concat(canvas.foreground.tiles),t=p.map((e=>e.id));for(let a of e)g.set(a.data._id,[a,a.data.hidden]),a.data.hidden=!t.includes(a.id),a.refresh()}if(!d){const e=canvas.background.tiles.concat(canvas.foreground.tiles);for(let t of e)g.has(t.data._id)||g.set(t.data._id,[t,t.data.hidden]),t.data.hidden||(t.data.hidden=VideoHelper.hasVideoExtension(t.data.img))}if(u===i.Roof)for(let e of canvas.background.tiles)g.has(e.data._id)||g.set(e.data._id,[e,e.data.hidden]),e.data.hidden=!0;const _=l.default.beginCapture(!1);for(let e of Object.keys(CONFIG.Canvas.layers))if(!["background","foreground","lighting"].includes(e))try{l.default.toggleLayer(e,!1)}catch(e){console.error(e)}l.default.toggleLayer("lighting",s),u===i.Floor&&l.default.toggleLayer("foreground",!1),canvas.background.bg&&(canvas.background.bg.visible=o),canvas.app.renderer.backgroundAlpha=0;const waitForDOMUpdate=async()=>new Promise((e=>setTimeout(e,10)));var f;await waitForDOMUpdate();try{if(!_)return ui.notifications.warn("DF_ARCHITECT.CaptureGameScreen.ErrorCaptureInProgress".localize()),void this.promptForTileFlattening();if(l.default.toggleHidden("background",c&&!h&&u!==i.Roof),l.default.toggleHidden("foreground",c&&!h&&u!==i.Floor),await waitForDOMUpdate(),"undefined"!=typeof _levels&&(_levels.floorContainer.visible=!1,_levels.overContainer.visible=!1,_levels.fogContainer.visible=!1,_levels.tokenRevealFogContainer.visible=!1),h){const e={l:Number.MAX_VALUE,t:Number.MAX_VALUE,r:Number.MIN_VALUE,b:Number.MIN_VALUE};for(let t of p){const a={minX:t.center.x-t.width/2,minY:t.center.y-t.height/2,maxX:t.center.x+t.width/2,maxY:t.center.y+t.height/2};a.minX<e.l&&(e.l=a.minX),a.minY<e.t&&(e.t=a.minY),a.maxX>e.r&&(e.r=a.maxX),a.maxY>e.b&&(e.b=a.maxY)}f=await l.default.captureCanvas({format:"image/"+t,quality:a,view:{x:-r.l+e.l,y:-r.t+e.t,w:r.l+r.r+e.r-e.l,h:r.t+r.b+e.b-e.t,s:1}})}else f=await l.default.captureCanvas({format:"image/"+t,quality:a})}finally{"undefined"!=typeof _levels&&(_levels.floorContainer.visible=!0,_levels.overContainer.visible=!0,_levels.fogContainer.visible=!0,_levels.tokenRevealFogContainer.visible=!0),l.default.endCapture(_),canvas.background.bg&&(canvas.background.bg.visible=!0),canvas.app.renderer.backgroundAlpha=1;for(let[e,[t,a]]of g)t.data.hidden=a,t.refresh();p.forEach((e=>e.control({releaseOthers:!1})))}l.default.saveImageData({image:f,defaultFileName:"DF_ARCHITECT.TileFlattener.SaveImageDialog.FileNamePlaceholder".localize(),dialogTitle:"DF_ARCHITECT.TileFlattener.SaveImageDialog.Title".localize(),folder:this.folder,folderSource:this.folderSource}).then((e=>{e&&this.promptSceneReplacement(e,f.width,f.height,u,s)}))}static setupBindings(e){const t=$(e),a=t.find("table"),i=t.find("#hidden"),r=t.find("#canvas"),n=t.find("#tiles"),update=()=>{r[0].checked?(a.find("input").prop("disabled",!0),i.prop("disabled",!1)):(a.find("input").prop("disabled",!1),i.prop("disabled",!0))};r.on("change",update),n.on("change",update);const l=t.find("#compression");l.on("input",(()=>l.trigger("change"))),l.on("change",(()=>t.find("#compression-output").val(l.val())))}static async promptSceneReplacement(e,t,a,n,l){const s=new Dialog({title:"DF_ARCHITECT.TileFlattener.SceneReplaceDialog.Title".localize(),content:await renderTemplate(`modules/${r.default.MOD_NAME}/templates/tile-flatten-scene.hbs`,{}),buttons:{cancel:{icon:'<i class="fas fa-times"></i>',label:"DF_ARCHITECT.TileFlattener.SceneReplaceDialog.DoNothing".localize(),callback:()=>s.close()}},default:"cancel",render:r=>{const o=$(r);o.find("#replace").on("click",(async t=>{t.preventDefault(),s.close(),await game.scenes.viewed.update({img:e},{})})),o.find("#clone").on("click",(async t=>{t.preventDefault();const a=await game.scenes.viewed.clone({name:game.scenes.viewed.name+" (Copy)",img:e},{save:!0});var r=a.data.tiles.map((e=>e.data));this.renderSelected?r=canvas.background.controlled.map((e=>e.data)):(n===i.Floor?r=r.filter((e=>!e.overhead)):n===i.Roof&&(r=r.filter((e=>e.overhead))),this.renderHidden||(r=r.filter((e=>!e.hidden)))),await a.deleteEmbeddedDocuments("Tile",r.map((e=>e._id)));const o=await a.createThumbnail();await a.update({thumb:o.thumb},{diff:!1}),l&&await a.deleteEmbeddedDocuments("AmbientLight",a.data.lights.map((e=>e.id))),s.close()})),o.find("#tile").on("click",(async i=>{i.preventDefault();const r=(game.scenes.viewed.data.width-t)/2,n=(game.scenes.viewed.data.height-a)/2;await game.scenes.viewed.createEmbeddedDocuments(TileDocument.documentName,[{img:e,x:r,y:n,z:0,width:t,height:a}]),s.close()}))}});s.render(!0)}}},(e,t,a)=>{a.r(t),a.d(t,{default:()=>ArchiveFolderMenu});var i=a(3),r=a(2),n=a(22);class ArchiveFolderMenu extends FormApplication{static get defaultOptions(){return mergeObject(FormApplication.defaultOptions,{width:400,height:125,resizable:!1,minimizable:!1,title:"DF_ARCHITECT.TileFlattener.ImageFolderTitle",template:`modules/${i.default.MOD_NAME}/templates/folder-selection.hbs`,submitOnClose:!1,submitOnChange:!1,closeOnSubmit:!0})}folder=r.default.get(n.default.PREF_FOLDER);source=r.default.get(n.default.PREF_FOLDER_SOURCE);getData(e){return{path:this.folder}}async _renderInner(e){const t=await super._renderInner(e),a=t.find("input#dfce-ca-folder-path")[0];return t.find("label>button").on("click",(async e=>{e.preventDefault();const t=new FilePicker({current:r.default.get(n.default.PREF_FOLDER),title:"DF_ARCHITECT.TileFlattener.ImageFolderTitle",type:"folder",field:a,callback:async e=>{this.source=t.activeSource,this.folder=e},button:e.currentTarget});await t.browse("")})),t}async _updateObject(e,t){await r.default.set(n.default.PREF_FOLDER,this.folder),await r.default.set(n.default.PREF_FOLDER_SOURCE,this.source)}}},(e,t,a)=>{a.r(t),a.d(t,{default:()=>LightCounter});var i=a(3),r=a(25),n=a(2);class LightCounter{static _counter=new r.default(0,"Lights");static ready(){libWrapper.register(i.default.MOD_NAME,"LightingLayer.prototype.activate",(e=>{e(),this.updateCount(),n.default.get("General.ShowCounters")&&this._counter.render(!0)}),"WRAPPER"),libWrapper.register(i.default.MOD_NAME,"LightingLayer.prototype.deactivate",(e=>{e(),this._counter.rendered&&this._counter.close()}),"WRAPPER"),Hooks.on("createAmbientLight",(()=>this.updateCount())),Hooks.on("updateAmbientLight",(()=>this.updateCount())),Hooks.on("deleteAmbientLight",(()=>this.updateCount()))}static updateCount(){if(!n.default.get("General.ShowCounters"))return;const e=canvas.lighting.objects.children;this._counter.count=e.length;var t=0,a=0,i=0,r=0;e.forEach((e=>{const n=(e.document.vision?16:0)|(e.document.walls?1:0);1==n?t++:17==n?i++:0==n?a++:16==n&&r++})),this._counter.hint=`<pre style="margin:0">\n                        Normal: ${t}\n               Provides Vision: ${i}\n                  Unrestrained: ${a}\nUnrestrained & Provides Vision: ${r}\n</pre>`}}},(e,t,a)=>{a.r(t),a.d(t,{default:()=>CounterUI});var i=a(3);class CounterUI extends Application{static get defaultOptions(){return mergeObject(Application.defaultOptions,{title:null,height:100,width:100,minimizable:!1,resizable:!1,template:"modules/df-architect/templates/counter-ui.hbs",popOut:!1})}_count=0;_label="";_hint="";static init(){game.modules.get("lib-df-buttons")?.active||(libWrapper.register(i.default.MOD_NAME,"Sidebar.prototype.expand",(function(e){Hooks.callAll("collapseSidebarPre",this,!this._collapsed),e()}),"WRAPPER"),libWrapper.register(i.default.MOD_NAME,"Sidebar.prototype.collapse",(function(e){Hooks.callAll("collapseSidebarPre",this,!this._collapsed),e()}),"WRAPPER"))}constructor(e,t){super(),this._count=e,this.label=t}get count(){return this._count}set count(e){this._count=e,this.element.find("#count").val(e)}get label(){return this._label}set label(e){this._label=e,this.element.find("#label").val(e)}get hint(){return this._hint}set hint(e){this._hint=e}getData(e){return{count:this._count,label:this._label}}_injectHTML(e){document.body.appendChild(e[0]),this._element=e;const t=e[0].offsetWidth;e.css("width","0"),e.animate({padding:".5em 1em",width:`${t}px`},200,(()=>{e.css("width","")}))}async _render(e=!1,t={}){if(Hooks.on("collapseSidebarPre",this._handleSidebarCollapse.bind(this)),await super._render(e,t),ui.sidebar._collapsed&&this.element.css("right","35px"),game.modules.get("fpsmeter")?.active){const e=document.querySelector("div.fpsCounter"),t=e.offsetTop,a=t+e.offsetHeight,i=this.element[0].offsetTop-5,r=this.element[0].offsetHeight+5;(t<=i&&a>=i||t>=i&&t<=r||a>=i&&a<=r)&&(this.element[0].style.top=`${a+5}px`)}game.modules.get("lib-df-buttons")?.active&&(this.element[0].style.top="unset",this.element[0].style.bottom="8px"),this.element.on("pointerenter",(e=>game.tooltip.activate(e.target,{text:this._hint,direction:"LEFT"})))}close(e={}){Hooks.off("collapseSidebarPre",this._handleSidebarCollapse.bind(this));const t=Application.RENDER_STATES;if(!e.force&&![t.RENDERED,t.ERROR].includes(this._state))return;this._state=t.CLOSING;let a=this.element;if(!a)return this._state=t.CLOSED;a.css({minHeight:0});for(let e of this.constructor._getInheritanceChain())Hooks.call(`close${e.name}`,this,a);return new Promise((e=>{a.animate({padding:".5em 0",width:"0"},200,(()=>{a.remove(),this._element=null,delete ui.windows[this.appId],this._minimized=!1,this._scrollPositions=null,this._state=t.CLOSED,e()}))}))}_handleSidebarCollapse(e,t){t?this.element.delay(250).animate({right:"35px"},150):this.element.animate({right:"305px"},150)}}},(e,t,a)=>{a.r(t),a.d(t,{default:()=>WallsCounter});var i=a(3),r=a(25),n=a(2);class WallsCounter{static _counter=new r.default(0,"Walls");static ready(){libWrapper.register(i.default.MOD_NAME,"WallsLayer.prototype.activate",(e=>{e(),this.updateCount(),n.default.get("General.ShowCounters")&&this._counter.render(!0)}),"WRAPPER"),libWrapper.register(i.default.MOD_NAME,"WallsLayer.prototype.deactivate",(e=>{e(),this._counter.rendered&&this._counter.close()}),"WRAPPER"),Hooks.on("createWall",(()=>this.updateCount())),Hooks.on("deleteWall",(()=>this.updateCount())),Hooks.on("updateWall",(()=>this.updateCount()))}static updateCount(){if(!n.default.get("General.ShowCounters"))return;const e=canvas.walls.objects.children;this._counter.count=e.length;var t=0,a=0,i=0,r=0,l=0,s=0,o=0,c=0,d=0;e.forEach((e=>{e.document.door==foundry.CONST.WALL_DOOR_TYPES.DOOR&&t++,e.document.door==foundry.CONST.WALL_DOOR_TYPES.SECRET&&a++,e.document.move==foundry.CONST.WALL_MOVEMENT_TYPES.NORMAL&&i++,e.document.light==foundry.CONST.WALL_SENSE_TYPES.NORMAL&&r++,e.document.light==foundry.CONST.WALL_SENSE_TYPES.LIMITED&&l++,e.document.sight==foundry.CONST.WALL_SENSE_TYPES.NORMAL&&s++,e.document.sight==foundry.CONST.WALL_SENSE_TYPES.LIMITED&&o++,e.document.sound==foundry.CONST.WALL_SENSE_TYPES.NORMAL&&c++,e.document.sound==foundry.CONST.WALL_SENSE_TYPES.LIMITED&&d++})),this._counter.hint=`<pre style="margin:0">\n         Doors: ${t}\n  Secret Doors: ${a}<br>\n Move Blocking: ${i}<br>\nLight Blocking: ${r}\nLight Limiting: ${l}<br>\nSight Blocking: ${s}\nSight Limiting: ${o}<br>\nSound Blocking: ${c}\nSound Limiting: ${d}\n</pre>`}}},(e,t,a)=>{a.r(t),a.d(t,{default:()=>TileCounter});var i=a(3),r=a(25),n=a(2);class TileCounter{static _counter=new r.default(0,"Tiles");static ready(){libWrapper.register(i.default.MOD_NAME,"TilesLayer.prototype.activate",(e=>{e(),this.updateCount(),n.default.get("General.ShowCounters")&&this._counter.render(!0)}),"WRAPPER"),libWrapper.register(i.default.MOD_NAME,"TilesLayer.prototype.deactivate",(e=>{e(),this._counter.rendered&&"ForegroundLayer"!==canvas.activeLayer?.name&&this._counter.close()}),"WRAPPER"),Hooks.on("createTile",this.updateCount.bind(this)),Hooks.on("deleteTile",this.updateCount.bind(this)),Hooks.on("updateTile",this.updateCount.bind(this))}static updateCount(){if(!n.default.get("General.ShowCounters"))return;const e=canvas.tiles.objects.children.map((e=>e.document.overhead));this._counter.count=e.length,this._counter.hint=`<pre style="margin:0">\nFloors: ${e.filter((e=>!e)).length}\n Roofs: ${e.filter((e=>e)).length}\n</pre>`}}},(e,t,a)=>{a.r(t),a.d(t,{default:()=>SoundCounter});var i=a(3),r=a(25),n=a(2);class SoundCounter{static _counter=new r.default(0,"Sounds");static ready(){libWrapper.register(i.default.MOD_NAME,"SoundsLayer.prototype.activate",(e=>{e(),this.updateCount(),n.default.get("General.ShowCounters")&&this._counter.render(!0)}),"WRAPPER"),libWrapper.register(i.default.MOD_NAME,"SoundsLayer.prototype.deactivate",(e=>{e(),this._counter.rendered&&this._counter.close()}),"WRAPPER"),Hooks.on("createAmbientSound",(()=>this.updateCount())),Hooks.on("deleteAmbientSound",(()=>this.updateCount())),Hooks.on("updateAmbientSound",(()=>this.updateCount()))}static updateCount(){if(!n.default.get("General.ShowCounters"))return;const e=canvas.sounds.objects.children;this._counter.count=e.length,this._counter.hint=`<pre style="margin:0">\n      Normal Sounds: ${e.filter((e=>e.document.walls)).length}\nUnrestrained Sounds: ${e.filter((e=>!e.document.walls)).length}\n</pre>`}}},(e,t,a)=>{a.r(t),a.d(t,{default:()=>ShowLayerControls});var i=a(3),r=a(2);class ShowLayerControls{static PREF_WALLS="ShowLayerControls.WallsLayer";static PREF_LIGHT="ShowLayerControls.LightingLayer";static PREF_SOUND="ShowLayerControls.SoundsLayer";static _ready=!1;static get showWalls(){return game.user.isGM&&r.default.get(ShowLayerControls.PREF_WALLS)}static get showLights(){return game.user.isGM&&r.default.get(ShowLayerControls.PREF_LIGHT)}static get showSounds(){return game.user.isGM&&r.default.get(ShowLayerControls.PREF_SOUND)}static async toggleLayer(e,t,a){await r.default.set(t,a);const i=ui.controls.controls.find((t=>t.layer==e));a?i.icon+=" df-arch-layervisible":i.icon.indexOf(" df-arch-layervisible")>0&&(i.icon=i.icon.substring(0,i.icon.indexOf(" df-arch-layervisible"))),setTimeout((()=>ui.controls.render()),100)}static init(){r.default.register(this.PREF_WALLS,{config:!1,scope:"client",type:Boolean,default:!1}),r.default.register(this.PREF_LIGHT,{config:!1,scope:"client",type:Boolean,default:!1}),r.default.register(this.PREF_SOUND,{config:!1,scope:"client",type:Boolean,default:!1}),Hooks.on("getSceneControlButtons",(e=>{if(!game.user.isGM)return;const t=e.find((e=>"walls"===e.name)),a=e.find((e=>"lighting"===e.name)),i=e.find((e=>"sounds"===e.name));this.showWalls&&(t.icon+=" df-arch-layervisible"),t.tools.unshift({icon:"fas fa-eye",name:"flatten",toggle:!0,active:r.default.get(this.PREF_WALLS),title:"DF_ARCHITECT.ShowLayerControls.Walls",onClick:e=>this.toggleLayer("walls",ShowLayerControls.PREF_WALLS,e)}),this.showLights&&(a.icon+=" df-arch-layervisible"),a.tools.unshift({icon:"fas fa-eye",name:"flatten",toggle:!0,active:r.default.get(this.PREF_LIGHT),title:"DF_ARCHITECT.ShowLayerControls.Lights",onClick:e=>this.toggleLayer("lighting",ShowLayerControls.PREF_LIGHT,e)}),this.showSounds&&(i.icon+=" df-arch-layervisible"),i.tools.unshift({icon:"fas fa-eye",name:"flatten",toggle:!0,active:r.default.get(this.PREF_SOUND),title:"DF_ARCHITECT.ShowLayerControls.Sounds",onClick:e=>this.toggleLayer("sounds",ShowLayerControls.PREF_SOUND,e)})})),Hooks.on("updateWall",(()=>{if(!game.user.isGM)return;const refreshLayer=e=>{e._active=!0,e.objects.children.forEach((e=>{e.updateSource(),e.refresh()})),e._active=!1};this.showLights&&refreshLayer(canvas.lighting),this.showSounds&&refreshLayer(canvas.sounds)})),Hooks.on("deleteWall",(()=>{if(!game.user.isGM)return;const refreshLayer=e=>{e._active=!0,e.objects.children.forEach((e=>{e.updateSource(),e.refresh()})),e._active=!1};this.showLights&&refreshLayer(canvas.lighting),this.showSounds&&refreshLayer(canvas.sounds)}))}static ready(){this._ready=!0;const e=this.showWalls,t=this.showLights,a=this.showSounds;e&&(canvas.walls.activate(),canvas.walls.deactivate()),t&&(canvas.lighting.activate(),canvas.lighting.deactivate()),a&&(canvas.sounds.activate(),canvas.sounds.deactivate()),(e||t||a)&&setTimeout((()=>canvas.tokens.activate()),1),game.user.isGM&&libWrapper.register(i.default.MOD_NAME,"PlaceablesLayer.prototype.deactivate",this.PlaceablesLayer_deactivate,"MIXED")}static AmbientLight_refresh(){const{x:e,y:t}=this.document;this.position.set(e,t),this.field.position.set(-e,-t);const a=this.field.clear();this.source.los&&a.lineStyle(2,15658734,.4).drawShape(this.source.los),this.refreshControl(),this.controlIcon.visible=!0}static PlaceablesLayer_deactivate(e){if(!ShowLayerControls._ready)return e();var t=!1;switch(this.name){case"WallsLayer":t=ShowLayerControls.showWalls;break;case"LightingLayer":t=ShowLayerControls.showLights;break;case"SoundsLayer":t=ShowLayerControls.showSounds}if(!t)return e();switch(InteractionLayer.prototype.deactivate.bind(this)(),this.objects.visible=!0,this.preview&&this.preview.removeChildren(),this.name){case"LightingLayer":this.objects.children.forEach((e=>ShowLayerControls.AmbientLight_refresh.apply(e)));case"SoundsLayer":this.objects.children.forEach((e=>e.controlIcon.visible=!0))}return this}}},(e,t,a)=>{a.r(t),a.d(t,{default:()=>TileConfigExt});var i=a(2);function reduce(e,t){for(var a,i=e,r=t;r;)a=i%r,i=r,r=a;return[e/i,t/i]}class TileConfigExt{static PREF_SHOW_CONTROLS="TileConfigExt.ShowControls";static _previewImageHTML='<section class="df-arch-tile-config">\n\t<img id="img-preview" style="display: none;">\n\t<video id="anim-preview" style="display: none;" autoplay muted loop></video>\n\t<output id="img-data" />\n</section>';static init(){i.default.register(this.PREF_SHOW_CONTROLS,{name:"DF_ARCHITECT.TileConfigExt.SettingControlsName",hint:"DF_ARCHITECT.TileConfigExt.SettingControlsHint",config:!0,scope:"world",type:Boolean,default:!0}),Hooks.on("renderTileConfig",this.updateTileConfig.bind(this))}static updateTileConfig(e,t,a){const i=t.find('input[name="texture.src"]');i.parent().parent().before($(this._previewImageHTML)),i.on("change",(()=>this.updateImagePreview(e))),this.updateImagePreview(e);const r="Scale the width to the aspect ratio relative to the current height".localize(),n="Scale the height to the aspect ratio relative to the current width".localize(),l=t.find('input[name="width"]'),s=t.find('input[name="height"]');l.after($(`<button class="df-arch-scale" title="${r}"><i class="fas fa-arrows-alt-h"></i></button>`).on("click",(t=>{t.preventDefault();const a=e.ratio.num/e.ratio.den;l.val(Math.round(parseInt(s.val())*a)).trigger("change")}))),s.after($(`<button class="df-arch-scale" title="${n}"><i class="fas fa-arrows-alt-v"></i></button>`).on("click",(t=>{t.preventDefault();const a=e.ratio.num/e.ratio.den;s.val(Math.round(parseInt(l.val())/a)).trigger("change")}))),e.setPosition({left:e.position.left,top:e.position.top})}static updateImagePreview(e){if(""===e.element.find('input[name="img"]').val())return;const t="DF_ARCHITECT.TileConfigExt.LabelDimens".localize(),a="DF_ARCHITECT.TileConfigExt.LabelAspect".localize(),r=e.element.find("#img-preview")[0],n=e.element.find("#anim-preview")[0],l=e.element.find("#img-data")[0],s=e.element.find('input[name="texture.src"]').val();if(VideoHelper.hasVideoExtension(s))$(r).hide(),$(n).show(),n.controls=i.default.get(this.PREF_SHOW_CONTROLS),n.addEventListener("loadedmetadata",(()=>{const[i,r]=reduce(n.videoWidth,n.videoHeight);e.ratio={num:i,den:r},l.innerHTML=`<b>${t}</b><br>${n.videoWidth}px x ${n.videoHeight}px<br><br><b>${a}</b><br>${i}:${r}`})),n.src=s,n.load();else{$(r).show(),$(n).hide(),r.src=s;const i=new Image;i.onload=()=>{const[r,n]=reduce(i.width,i.height);e.ratio={num:r,den:n},l.innerHTML=`<b>${t}</b><br>${i.width}px x ${i.height}px<br><br><b>${a}</b><br>${r}:${n}`},i.src=r.src}}}},(e,t,a)=>{a.r(t),a.d(t,{default:()=>WallGapFiller});var i=a(2);class WallGapFiller{static PREF_GAP_THRESHOLD="WallGapFiller.GapThreshold";static get threshold(){return i.default.get(this.PREF_GAP_THRESHOLD)}static init(){Hooks.on("getSceneControlButtons",(e=>{const t=e.find((e=>"walls"===e.name));t.tools.splice(t.tools.findIndex((e=>"join"===e.name))+1,0,{icon:"fas fa-vector-square",name:"wall-gaps",title:"DF_ARCHITECT.WallGapFiller.ToolButtonLabel",button:!0,visible:game.user.isGM,onClick:this._fillGaps.bind(this)})}))}static ready(){i.default.register(this.PREF_GAP_THRESHOLD,{scope:"world",config:!0,default:5,type:Number,name:"DF_ARCHITECT.WallGapFiller.SettingName",hint:"DF_ARCHITECT.WallGapFiller.SettingHint"})}static _calculateWallGap(e,t){const a=e.c,i=t.c,r=[(a[0]-i[0])**2+(a[1]-i[1])**2,[a[0]+i[0],a[1]+i[1]]],n=[(a[2]-i[2])**2+(a[3]-i[3])**2,[a[2]+i[2],a[3]+i[3]]],l=[(a[0]-i[2])**2+(a[1]-i[3])**2,[a[0]+i[2],a[1]+i[3]]],s=[(a[2]-i[0])**2+(a[3]-i[1])**2,[a[2]+i[0],a[3]+i[1]]];let o;return o=r[0]<n[0]&&r[0]<l[0]&&r[0]<s[0]?r:n[0]<l[0]&&n[0]<s[0]?n:l[0]<s[0]?l:s,{midpoint:{x:o[1][0]/2,y:o[1][1]/2},distanceSquared:o[0]}}static async _findWallGaps(){return new Promise((e=>{const t=canvas.walls.objects.children,a=[],i=this.threshold**2;let r;for(let e=0;e<t.length;e++)for(let n=e+1;n<t.length;n++)r=this._calculateWallGap(t[e].data,t[n].data),r.distanceSquared>i||0===r.distanceSquared||(r.wallA=t[e],r.wallB=t[n],a.push(r));e(a)}))}static async _fillGaps(){const e=$(`<div id="dfarch-temp-overlay" style="background:#444c"><h1>${"DF_ARCHITECT.WallGapFiller.DetectGapsLabel".localize()}</h1><div class="dfarch-dual-ring"></div></div>`);e.appendTo(document.body);const t=await this._findWallGaps();if(e.remove(),0===t.length)return void Dialog.prompt({callback:()=>{},content:`<p>${"DF_ARCHITECT.WallGapFiller.NoGaps".localize()}</p>`,title:"DF_ARCHITECT.WallGapFiller.DialogTitle".localize()});const a=new PIXI.Graphics;canvas.walls.addChild(a),a.lineStyle(3,65280,.7),a.beginFill(0,0);for(const e of t)a.drawCircle(e.midpoint.x,e.midpoint.y,Math.sqrt(e.distanceSquared)/2+8);a.endFill();if(await Dialog.confirm({title:"DF_ARCHITECT.WallGapFiller.DialogTitle".localize(),content:`<p>${"DF_ARCHITECT.WallGapFiller.GapsDetected".localize().replace("{count}",t.length.toString())}</p>`,defaultYes:!0})){let e=0,a=0;SceneNavigation.displayProgressBar({label:"DF_ARCHITECT.WallGapFiller.ProgressLabel".localize().replace("{0}","0").replace("{1}",t.length.toString()),pct:0});let i=0;for(const r of t)e=(r.wallA.data.c[0]-r.midpoint.x)**2+(r.wallA.data.c[1]-r.midpoint.y)**2,a=(r.wallA.data.c[2]-r.midpoint.x)**2+(r.wallA.data.c[3]-r.midpoint.y)**2,e<a?await r.wallA.document.update({c:[r.midpoint.x,r.midpoint.y,r.wallA.data.c[2],r.wallA.data.c[3]]}):await r.wallA.document.update({c:[r.wallA.data.c[0],r.wallA.data.c[1],r.midpoint.x,r.midpoint.y]}),e=(r.wallB.data.c[0]-r.midpoint.x)**2+(r.wallB.data.c[1]-r.midpoint.y)**2,a=(r.wallB.data.c[2]-r.midpoint.x)**2+(r.wallB.data.c[3]-r.midpoint.y)**2,e<a?await r.wallB.document.update({c:[r.midpoint.x,r.midpoint.y,r.wallB.data.c[2],r.wallB.data.c[3]]}):await r.wallB.document.update({c:[r.wallB.data.c[0],r.wallB.data.c[1],r.midpoint.x,r.midpoint.y]}),SceneNavigation.displayProgressBar({label:"DF_ARCHITECT.WallGapFiller.ProgressLabel".localize().replace("{0}",(++i).toString()).replace("{1}",t.length.toString()),pct:i/t.length*100})}canvas.walls.removeChild(a),a.destroy({children:!0})}}}],t={};function __webpack_require__(a){var i=t[a];if(void 0!==i)return i.exports;var r=t[a]={exports:{}};return e[a](r,r.exports,__webpack_require__),r.exports}__webpack_require__.d=(e,t)=>{for(var a in t)__webpack_require__.o(t,a)&&!__webpack_require__.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),__webpack_require__.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var a={};(()=>{__webpack_require__.r(a);var e=__webpack_require__(1),t=__webpack_require__(2),i=__webpack_require__(3),r=__webpack_require__(4),n=__webpack_require__(5),l=__webpack_require__(6),s=__webpack_require__(7),o=__webpack_require__(9),c=__webpack_require__(10),d=__webpack_require__(11),h=__webpack_require__(12),u=__webpack_require__(13),g=__webpack_require__(16),p=__webpack_require__(17),_=__webpack_require__(18),f=__webpack_require__(19),m=__webpack_require__(20),C=__webpack_require__(21),E=__webpack_require__(22),y=__webpack_require__(24),b=__webpack_require__(26),v=__webpack_require__(27),T=__webpack_require__(28),S=__webpack_require__(29),R=__webpack_require__(30),A=__webpack_require__(25),L=__webpack_require__(31);(0,e.default)(),t.default.init(i.default.MOD_NAME),Hooks.once("init",(function(){if(game.modules.get("lib-wrapper")?.active&&game.modules.get("colorsettings")?.active){i.default.DrawArchitectGraphicToConsole();try{C.default.init()}catch(e){console.error(e)}try{S.default.init()}catch(e){console.error(e)}try{l.default.init()}catch(e){console.error(e)}try{n.default.init()}catch(e){console.error(e)}try{o.default.init()}catch(e){console.error(e)}try{s.default.init()}catch(e){console.error(e)}try{c.default.init()}catch(e){console.error(e)}try{L.default.init()}catch(e){console.error(e)}try{_.default.init()}catch(e){console.error(e)}try{m.default.init()}catch(e){console.error(e)}try{d.default.init()}catch(e){console.error(e)}try{u.default.init()}catch(e){console.error(e)}try{g.LightTemplateManager.init()}catch(e){console.error(e)}try{E.default.init()}catch(e){console.error(e)}try{R.default.init()}catch(e){console.error(e)}try{A.default.init()}catch(e){console.error(e)}t.default.register("General.ShowCounters",{name:"DF_ARCHITECT.General.ShowCounterName".localize(),hint:"DF_ARCHITECT.General.ShowCounterHint".localize(),config:!0,scope:"world",type:Boolean,default:!0})}})),Hooks.once("setup",(function(){game.modules.get("lib-wrapper")?.active&&game.modules.get("colorsettings")?.active&&r.default.setup()})),Hooks.once("ready",(async function(){if(!game.modules.get("lib-wrapper")?.active)return console.error("Missing libWrapper module dependency"),void(game.user.isGM&&ui.notifications.error("DF_ARCHITECT.ErrorLibWrapperMissing".localize()));if(!game.modules.get("colorsettings")?.active)return console.error("Missing colorsettings module dependency"),void(game.user.isGM&&ui.notifications.error("DF_ARCHITECT.ErrorColourSettingsMissing".localize()));await C.default.ready();try{r.default.ready()}catch(e){console.error(e)}try{n.default.ready()}catch(e){console.error(e)}try{s.default.ready()}catch(e){console.error(e)}try{p.default.ready()}catch(e){console.error(e)}try{L.default.ready()}catch(e){console.error(e)}try{_.default.ready()}catch(e){console.error(e)}try{m.default.ready()}catch(e){console.error(e)}try{d.default.ready()}catch(e){console.error(e)}try{h.QuickColourPicker.ready()}catch(e){console.error(e)}try{f.default.ready()}catch(e){console.error(e)}try{g.LightTemplateManager.ready()}catch(e){console.error(e)}try{g.LightingLayerOverride.ready()}catch(e){console.error(e)}try{S.default.ready()}catch(e){console.error(e)}try{y.default.ready()}catch(e){console.error(e)}try{b.default.ready()}catch(e){console.error(e)}try{v.default.ready()}catch(e){console.error(e)}try{T.default.ready()}catch(e){console.error(e)}}))})()})();
//# sourceMappingURL=df-architect.js.map